<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Re - Minko - Перерождение стиля. Интернет-магазин премиум товаров с доставкой по всему миру. Качественные продукты, безопасные платежи, лучший сервис.">
    <meta name="keywords" content="интернет-магазин, премиум товары, доставка, покупки онлайн, Re Minko, перерождение стиля">
    <meta name="author" content="Re - Minko">
    <meta property="og:title" content="Re - Minko - Перерождение стиля">
    <meta property="og:description" content="Интернет-магазин премиум товаров с доставкой по всему миру">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://re-minko.com">
    <meta property="og:image" content="https://re-minko.com/og-image.png">
    <meta property="og:site_name" content="Re - Minko">
    <link rel="canonical" href="https://re-minko.com">
    <title>Re - Minko - Перерождение стиля</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='60' font-weight='bold' fill='white' font-family='Arial, sans-serif'%3EM%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon-32x32.png">
    <meta name="theme-color" content="#667eea">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #0f1111;
            background: #ffffff;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
        }

        .main, .header, .footer {
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .sidebar-content {
            padding: 1rem;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .sidebar-categories {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-category {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
        }

        .sidebar-category:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-action {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: #667eea;
            color: white;
            text-align: left;
            font-size: 14px;
        }

        .sidebar-action:hover {
            background: #5a6fd8;
        }

        .sidebar-action.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .sidebar-action.secondary:hover {
            background: #e9ecef;
        }

        /* Main content with sidebar */
        .main-with-sidebar {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        .main-with-sidebar.sidebar-open {
            margin-left: 300px;
        }

        /* Sidebar toggle button */
        .sidebar-toggle {
            position: fixed;
            left: 10px;
            top: 80px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-toggle:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .hamburger-line {
            width: 16px;
            height: 2px;
            background: white;
            border-radius: 1px;
            transition: all 0.3s;
        }

        /* Minimalist logo */
        .minimalist-logo {
            position: fixed;
            left: 20px;
            top: 20px;
            z-index: 1000;
            color: #333;
            font-family: 'Georgia', serif;
            font-weight: 300;
            font-size: 2.2rem;
            letter-spacing: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #333, #666);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Header - Amazon Style */
        .header {
            background: #131921;
            color: #ffffff;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: none;
            border-bottom: none;
        }

        .header-top {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            gap: 1rem;
            background: #131921;
        }

        .header-nav {
            background: #232f3e;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-category {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #ffffff;
            font-size: 14px;
            border: 1px solid transparent;
            border-radius: 2px;
            transition: border-color 0.2s;
            position: relative;
        }

        .nav-category:hover {
            border-color: #ffffff;
        }
        
        .nav-category:hover .subcategories-menu {
            display: block;
        }

        .nav-category span:first-child {
            font-size: 16px;
        }
        
        .subcategories-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            display: none;
            z-index: 1000;
        }
        
        .subcategory-item {
            padding: 0.75rem 1rem;
            color: #0f1111;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .subcategory-item:last-child {
            border-bottom: none;
        }
        
        .subcategory-item:hover {
            background: #f8f9fa;
            color: #ff9900;
        }

        .header-logo {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 120px;
        }

        .header-logo:hover {
            opacity: 0.8;
        }

        .logo-image {
            height: 35px;
            width: auto;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            font-family: inherit;
            letter-spacing: 0;
        }

        .logo-text-fallback {
            display: block !important;
        }

        .header-search {
            flex: 1;
            max-width: 900px;
            position: relative;
            display: flex;
        }

        .header-search input {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 4px 0 0 4px;
            font-size: 15px;
            outline: none;
            background: #ffffff;
            color: #0f1111;
            border: 3px solid transparent;
        }

        .header-search input:focus {
            border-color: #FF9900;
        }

        .header-search .search-btn {
            background: #febd69;
            border: none;
            padding: 10px 20px;
            border-radius: 0 4px 4px 0;
            color: #0f1111;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        .header-search .search-btn:hover {
            background: #f3a847;
        }

        .header-search .search-btn:active {
            background: #e8971e;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .header-action {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            padding: 8px 12px;
            border: 1px solid transparent;
            transition: border-color 0.2s;
            color: #ffffff;
            background: transparent;
            position: relative;
            text-align: left;
            min-width: 120px;
        }

        .header-action:hover {
            border-color: #ffffff;
        }

        .action-label {
            font-size: 12px;
            color: #cccccc;
            font-weight: 400;
            line-height: 1.2;
        }

        .action-value {
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.2;
        }

        .header-cart {
            position: relative;
        }

        .cart-icon-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-icon-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            color: #ffffff;
        }

        .cart-icon-wrapper svg {
            width: 38px;
            height: 26px;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            left: 18px;
            background: #ff9900;
            color: #0f1111;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-family: 'Times New Roman', serif;
        }

        .logo-main {
            font-size: 3.5rem;
            font-weight: bold;
            letter-spacing: 8px;
            color: #D4AF37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #FFD700, #B8860B, #D4AF37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-store {
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 4px;
            color: #D4AF37;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-family: Arial, sans-serif;
        }

        .logo-decoration {
            position: absolute;
            color: #D4AF37;
            font-size: 1.8rem;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .logo-decoration.left {
            left: -45px;
            top: 25px;
            transform: rotate(-20deg);
        }

        .logo-decoration.right {
            right: -55px;
            top: 20px;
            transform: rotate(20deg);
        }

        .logo-decoration.top {
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
        }

        .logo-decoration.left::before {
            content: '❦';
            font-size: 1.5rem;
            display: block;
            transform: scaleX(-1);
        }

        .logo-decoration.right::before {
            content: '❦';
            font-size: 1.5rem;
            display: block;
        }

        .logo-decoration.top::before {
            content: '❦';
            font-size: 1.2rem;
            display: block;
        }

        /* Additional decorative elements */
        .logo-decoration.left::after {
            content: '❦';
            font-size: 1rem;
            position: absolute;
            left: 15px;
            top: 10px;
            transform: rotate(45deg);
            opacity: 0.6;
        }

        .logo-decoration.right::after {
            content: '❦';
            font-size: 1rem;
            position: absolute;
            right: 15px;
            top: 10px;
            transform: rotate(-45deg);
            opacity: 0.6;
        }

        .search-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            max-width: 90vw;
            z-index: 1000;
        }

        .search-bar input {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .header-actions {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .cart-count {
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Navigation */
        .nav {
            background: white;
            padding: 0.8rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid #667eea;
            position: sticky;
            top: 80px;
            z-index: 999;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }

        .nav-categories {
            display: flex;
            gap: 2.5rem;
            flex-wrap: wrap;
        }

        .nav-categories a {
            text-decoration: none;
            color: #333;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            padding: 8px 16px;
            border-radius: 20px;
        }

        .nav-categories a:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-actions {
            display: flex;
            gap: 1.5rem;
        }

        .nav-actions a {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-actions a:hover {
            color: #667eea;
        }

        .categories-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .categories-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .categories-dropdown {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 1rem 0;
            padding: 2rem;
        }

        /* Breadcrumbs */
        .breadcrumbs {
            background: #f8f9fa;
            padding: 1rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .breadcrumbs-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .breadcrumbs a {
            color: #667eea;
            text-decoration: none;
            margin-right: 0.5rem;
        }

        .breadcrumbs a:hover {
            text-decoration: underline;
        }

        .breadcrumbs span {
            color: #666;
            margin: 0 0.5rem;
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            z-index: 1;
            background: #ffffff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        .recommended-section {
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            background: #ffffff;
            border-radius: 0;
            padding: 1.5rem 1rem;
            box-shadow: none;
            border: none;
        }

        .products-carousel-wrapper {
            position: relative;
            overflow: hidden;
            margin: 2rem 0;
        }

        .products-carousel {
            display: flex;
            gap: 2rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 1rem 0;
        }

        .products-carousel::-webkit-scrollbar {
            height: 8px;
        }

        .products-carousel::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        .products-carousel::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .categories-section {
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            background: #ffffff;
            border-radius: 0;
            padding: 1.5rem 1rem;
            box-shadow: none;
            border: none;
        }

        /* Hero Section - Amazon Style */
        .hero {
            background: #ffffff;
            color: #0f1111;
            padding: 0;
            border-radius: 0;
            text-align: left;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }

        .hero h1 {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: none;
        }

        .hero p {
            font-size: 1.4rem;
            margin-bottom: 2.5rem;
            opacity: 0.9;
        }

        .cta-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .cta-btn {
            background: #ff9900;
            color: #0f1111;
            padding: 10px 20px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .cta-btn:hover {
            background: #f3a847;
        }

        .cta-btn.secondary {
            background: #f0f0f0;
            color: #0f1111;
            border: 1px solid #d0d0d0;
        }

        .cta-btn.secondary:hover {
            background: #e0e0e0;
        }

        /* Categories */
        .categories {
            margin-bottom: 4rem;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-align: left;
            color: #0f1111;
            font-weight: 400;
            position: relative;
        }

        .section-title::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 120%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 50%;
            filter: blur(40px);
            z-index: -1;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 6px;
            background: linear-gradient(90deg, transparent, #667eea, #764ba2, #667eea, transparent);
            border-radius: 3px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .category-card {
            background: #ffffff;
            border-radius: 0;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: none;
            transition: background 0.2s;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .category-card:hover {
            background: #f8f9fa;
            border-color: #ff9900;
        }

        .category-icon {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            background: #f8f9fa;
            border-radius: 4px;
            transition: background 0.2s;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .category-card:hover .category-icon {
            background: #ff9900;
        }

        .category-card h3 {
            margin: 0;
            color: #0f1111;
            font-size: 0.9rem;
            font-weight: 400;
            position: relative;
            z-index: 1;
            flex: 1;
            text-align: left;
            line-height: 1.3;
        }

        /* Products */
        .products {
            margin-bottom: 4rem;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .filter-tabs {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 1px solid #d0d0d0;
            background: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 400;
            font-size: 14px;
        }

        .filter-tab.active {
            background: #ff9900;
            color: #0f1111;
            border-color: #ff9900;
        }

        .filter-tab:hover {
            border-color: #ff9900;
            color: #ff9900;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.2);
        }

        .sort-dropdown {
            padding: 10px 16px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 400;
            font-size: 14px;
        }

        .sort-dropdown:hover {
            border-color: #ff9900;
            box-shadow: 0 2px 8px rgba(255, 153, 0, 0.1);
        }
        
        .sort-dropdown:focus {
            border-color: #ff9900;
            outline: none;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .product-card {
            background: #ffffff;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            transition: box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            border: 1px solid #e0e0e0;
            padding: 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-color: #ff9900;
        }

        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #cc0c39;
            color: white;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 600;
            z-index: 2;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .product-badge.sale {
            background: #cc0c39;
        }

        .product-badge.new {
            background: #007185;
        }

        .product-badge.hot {
            background: #ff9900;
            color: #0f1111;
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #ccc;
            position: relative;
            overflow: hidden;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            margin-bottom: 0.5rem;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .product-card:hover .product-actions {
            opacity: 1;
        }

        .product-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .product-action-btn:hover {
            background: #ff9900;
            color: #0f1111;
            transform: scale(1.1);
        }
        
        .product-action-btn.active {
            background: #ff9900;
            color: #0f1111;
        }

        .product-info {
            padding: 0.5rem 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-title {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #0f1111;
            font-weight: 400;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.8rem;
        }

        .product-title:hover {
            color: #c45500;
        }

        .product-description {
            color: #666;
            font-size: 12px;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 400;
            color: #0f1111;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        
        .product-price .currency {
            font-size: 0.9rem;
            vertical-align: top;
        }

        .product-price .old-price {
            font-size: 1rem;
            color: #999;
            text-decoration: line-through;
        }

        .product-rating {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 5px;
        }

        .stars {
            color: #ffd700;
            font-size: 16px;
        }

        .rating-count {
            color: #666;
            font-size: 14px;
        }

        .product-buttons {
            display: flex;
            gap: 10px;
        }

        .add-to-cart {
            flex: 1;
            background: #ff9900;
            color: #0f1111;
            border: none;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .add-to-cart:hover {
            background: #f3a847;
        }

        .add-to-cart:active {
            transform: translateY(-1px);
        }

        .buy-now {
            background: #0f1111;
            color: #ffffff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-weight: 500;
            font-size: 14px;
        }
        
        .buy-now:hover {
            background: #333;
        }
        
        .buy-now:active {
            background: #000;
        }

        /* Features */
        .features {
            background: white;
            padding: 4rem 3rem;
            border-radius: 20px;
            margin-bottom: 4rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .feature {
            text-align: center;
            padding: 1.5rem;
            border-radius: 15px;
            transition: all 0.3s;
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .feature h3 {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1.1rem;
        }

        .feature p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Newsletter */
        .newsletter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 4rem;
        }

        .newsletter h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .newsletter p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .newsletter-form {
            display: flex;
            max-width: 500px;
            margin: 0 auto;
            gap: 1rem;
        }

        .newsletter-form input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .newsletter-form button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .newsletter-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        /* Footer - Amazon Style */
        .footer {
            background: #131921;
            color: #ffffff;
            padding: 3rem 0 1rem;
            margin-top: 3rem;
            border-top: none;
            position: relative;
            z-index: 1;
        }

        .footer-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            padding: 0 1rem 2rem;
        }

        .footer-section h3 {
            margin-bottom: 1rem;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 700;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-section ul li {
            margin-bottom: 0.75rem;
            font-size: 14px;
            line-height: 1.5;
        }

        .footer-section ul li a {
            color: #dddddd;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-section ul li a:hover {
            color: #ff9900;
            text-decoration: underline;
        }

        .footer-section ul li {
            position: relative;
        }

        .blog-submenu {
            list-style: none;
            padding: 0.5rem 0;
            margin: 0;
            position: absolute;
            top: 100%;
            left: 0;
            background: #232f3e;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            z-index: 1000;
        }

        .blog-submenu li {
            margin: 0;
            padding: 0;
        }

        .blog-submenu li a {
            color: #dddddd;
            text-decoration: none;
            display: block;
            padding: 0.5rem 1rem;
        }

        .blog-submenu li a:hover {
            color: #ff9900;
            background: rgba(255, 153, 0, 0.1);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #232f3e;
            color: #cccccc;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        /* User Cabinet Styles */
        .user-cabinet-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 2rem;
            color: white;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .user-info-main h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }
        
        .user-email {
            margin: 0.25rem 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .user-since {
            margin: 0.25rem 0 0 0;
            opacity: 0.8;
            font-size: 13px;
        }
        
        .cabinet-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        
        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.8rem;
            color: #0f1111;
            font-weight: 600;
        }
        
        .stat-content p {
            margin: 0 0 0.5rem 0;
            color: #666;
            font-size: 14px;
        }
        
        .stat-amount {
            display: block;
            color: #ff9900;
            font-weight: 600;
            font-size: 16px;
        }
        
        .stat-btn {
            background: #ff9900;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .stat-btn:hover {
            background: #e88700;
        }
        
        .cabinet-section {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .cabinet-section-title {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f1111;
        }
        
        .finance-summary {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .finance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .finance-item.total {
            background: #fff3cd;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .finance-label {
            color: #666;
            font-size: 14px;
        }
        
        .finance-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .finance-value.positive {
            color: #28a745;
        }
        
        .finance-value.negative {
            color: #dc3545;
        }
        
        .finance-value.pending {
            color: #ff9900;
        }
        
        .finance-value.total {
            color: #0f1111;
            font-size: 1.2rem;
        }
        
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .order-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .order-id {
            font-weight: 600;
            color: #0f1111;
            font-size: 14px;
        }
        
        .order-date {
            color: #666;
            font-size: 13px;
        }
        
        .order-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .order-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .order-status.status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .order-status.status-processing {
            background: #cfe2ff;
            color: #084298;
        }
        
        .order-status.status-shipped {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .order-status.status-delivered {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .order-total {
            font-weight: 600;
            color: #0f1111;
            font-size: 16px;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 2rem;
        }
        
        .view-all-btn {
            width: 100%;
            margin-top: 1rem;
            background: #f0f0f0;
            color: #0f1111;
            border: 1px solid #d0d0d0;
            padding: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .view-all-btn:hover {
            background: #e0e0e0;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .settings-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: #e9ecef;
            border-color: #ff9900;
        }
        
        .settings-btn span:first-child {
            font-size: 2rem;
        }
        
        .settings-btn span:last-child {
            font-size: 13px;
            color: #0f1111;
            text-align: center;
        }
        
        .cabinet-actions {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }
        
        .logout-btn {
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }

        .social-link {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .social-link:hover {
            background: #5a6fd8;
            transform: translateY(-3px);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            padding: 2rem;
            border-radius: 4px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid #e0e0e0;
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 400;
            color: #0f1111;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
        }

        .close-modal:hover {
            color: #0f1111;
            background: #f0f0f0;
        }

        /* Cart Modal */
        .cart-items {
            margin-bottom: 2rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid #e0e0e0;
            gap: 1rem;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            flex: 1;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-details h4 {
            margin-bottom: 0.5rem;
            color: #0f1111;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
        }

        .cart-item-details p {
            color: #666;
            font-size: 14px;
            margin: 0.25rem 0;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #d0d0d0;
            background: #ffffff;
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #0f1111;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            background: #f8f9fa;
            border-color: #ff9900;
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }

        .remove-item-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .remove-item-btn:hover {
            opacity: 1;
        }
        
        .cart-empty {
            text-align: center;
            padding: 3rem 1rem;
        }
        
        .cart-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .cart-empty-text {
            font-size: 1.2rem;
            color: #0f1111;
            margin: 0 0 0.5rem 0;
            font-weight: 500;
        }
        
        .cart-empty-subtext {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        
        .cart-item-price {
            color: #666;
            font-size: 13px;
            margin: 0.25rem 0;
        }
        
        .cart-item-seller {
            color: #999;
            font-size: 12px;
            margin: 0.25rem 0 0 0;
        }
        
        .cart-item-total {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }
        
        .cart-item-total-price {
            font-weight: 600;
            font-size: 16px;
            color: #0f1111;
        }
        
        .cart-summary {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 14px;
            color: #666;
        }
        
        .cart-summary-row:last-child {
            margin-bottom: 0;
        }
        
        .cart-summary-row.total {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 16px;
            color: #0f1111;
        }
        
        .cart-total-amount {
            color: #ff9900;
            font-size: 1.3rem;
        }

        .cart-total {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }

        .cart-total h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .checkout-btn {
            width: 100%;
            background: #ff9900;
            color: #0f1111;
            border: none;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkout-btn:hover:not(:disabled) {
            background: #f3a847;
        }

        .checkout-btn:active {
            background: #e8971e;
        }

        .checkout-btn:disabled {
            background: #d0d0d0;
            color: #666;
            cursor: not-allowed;
        }

        /* Product Detail Modal */
        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .product-detail-image {
            width: 100%;
            height: 400px;
            background: #f0f0f0;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6rem;
            color: #ccc;
        }

        .product-detail-info h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .product-detail-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 1rem;
        }

        .product-detail-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .product-detail-actions {
            display: flex;
            gap: 1rem;
        }

        /* Sell Product Form Styles */
        .sell-product-modal {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .sell-product-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .form-section {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .form-section-title {
            margin: 0 0 1.5rem 0;
            color: #0f1111;
            font-size: 1.1rem;
            font-weight: 400;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 400;
            color: #0f1111;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
            background: #ffffff;
            color: #0f1111;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff9900;
            box-shadow: 0 0 0 2px rgba(255, 153, 0, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            color: #666;
            font-size: 12px;
            margin-top: 0.25rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: white;
            border: 2px dashed #ff9900;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #ff9900;
            font-weight: 500;
        }

        .file-input-wrapper:hover .file-input-label {
            background: #fff8f0;
            border-color: #e88700;
        }

        .image-preview-container {
            margin-top: 1rem;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-item {
            position: relative;
            width: 100%;
            padding-top: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e9ecef;
        }

        .image-preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 2px solid #e9ecef;
        }

        .btn-primary {
            background: #ff9900;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #e88700;
        }

        .btn-secondary {
            background: #ffffff;
            color: #0f1111;
            border: 1px solid #d0d0d0;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #999;
        }

        /* Notifications - Amazon Style */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #ffffff;
            color: #0f1111;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 3000;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #ff9900;
            font-size: 14px;
            font-weight: 400;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification::before {
            content: '✓';
            color: #ff9900;
            font-weight: 700;
            font-size: 18px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: #cc0c39;
        }

        .notification.error::before {
            content: '✕';
            color: #cc0c39;
        }

        .notification.warning {
            border-left-color: #ff9900;
        }

        .notification.warning::before {
            content: '⚠';
            color: #ff9900;
        }

        .notification.info {
            border-left-color: #007185;
        }

        .notification.info::before {
            content: 'ℹ';
            color: #007185;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Quick Actions */
        .quick-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .quick-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #667eea;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Search Suggestions - Amazon Style */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
            font-size: 14px;
            color: #0f1111;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item svg {
            flex-shrink: 0;
            opacity: 0.6;
            width: 16px;
            height: 16px;
        }

        .suggestion-item:hover svg {
            opacity: 1;
        }

        .suggestion-item.history-item {
            color: #666;
        }

        .suggestion-item.history-item:hover {
            color: #ff9900;
        }

        .suggestion-item div {
            flex: 1;
        }

        .suggestion-item div small {
            display: block;
            color: #999;
            font-size: 12px;
            margin-top: 0.25rem;
        }

        .suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            background: #f8f9fa;
        }

        .clear-history-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            background: #e0e0e0;
            color: #0f1111;
        }

        /* Advanced Features Styles */
        
        /* Scroll Progress Bar */
        .scroll-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: #ff9900;
            z-index: 10000;
            transition: width 0.1s;
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #ff9900;
            color: #0f1111;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
            z-index: 999;
        }

        .back-to-top:hover {
            background: #f3a847;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .back-to-top.show {
            display: flex;
        }

        /* Price Filter Slider */
        .price-filter {
            padding: 1rem 0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            margin: 1rem 0;
        }

        .price-filter h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #0f1111;
        }

        .price-range {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .price-range input {
            flex: 1;
            padding: 8px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff9900;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff9900;
            cursor: pointer;
            border: none;
        }

        /* Compare Products */
        .compare-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 2px solid #ff9900;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            z-index: 1000;
            display: none;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .compare-bar.show {
            display: block;
            transform: translateY(0);
        }

        .compare-items {
            display: flex;
            gap: 1rem;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .compare-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .compare-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .compare-item .remove {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            padding: 0 5px;
        }

        .compare-btn {
            margin-left: auto;
            background: #ff9900;
            color: #0f1111;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Quick View Modal */
        .quick-view-modal {
            max-width: 900px;
        }

        .quick-view-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        /* Wishlist Button */
        .wishlist-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0e0e0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 3;
        }

        .wishlist-btn:hover {
            background: #ffffff;
            border-color: #ff9900;
            transform: scale(1.1);
        }

        .wishlist-btn.active {
            background: #ff9900;
            border-color: #ff9900;
            color: #0f1111;
        }

        /* Recently Viewed */
        .recently-viewed {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }

        .recently-viewed h3 {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 1rem;
            color: #0f1111;
        }

        .recently-viewed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .recent-item {
            cursor: pointer;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .recent-item:hover {
            border-color: #ff9900;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .recent-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        /* Product Rating Display */
        .product-rating-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .stars-filled {
            color: #ff9900;
            font-size: 14px;
        }

        .rating-number {
            font-size: 12px;
            color: #007185;
        }

        /* Breadcrumbs */
        .breadcrumbs {
            padding: 0.75rem 0;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .breadcrumbs a {
            color: #007185;
            text-decoration: none;
        }

        .breadcrumbs a:hover {
            text-decoration: underline;
            color: #c45500;
        }

        .breadcrumbs span {
            color: #999;
        }

        /* Smart Recommendations */
        .smart-recommendations {
            margin-top: 3rem;
            padding: 2rem;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .smart-recommendations h3 {
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            color: #0f1111;
        }

        /* Product Counter */
        .product-counter {
            font-size: 14px;
            color: #666;
            margin-left: 1rem;
        }

        /* Responsive Design */
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }

        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden;
                max-width: 100vw;
            }

            .header {
                padding: 0.8rem 0;
                width: 100%;
                max-width: 100vw;
            }

            .header-top {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
                align-items: stretch;
                width: 100%;
            }

            .header-logo {
                justify-content: center;
                order: 1;
            }

            .logo-image {
                height: 40px;
            }

            .logo-text {
                font-size: 1.5rem;
            }

            .header-search {
                order: 2;
                max-width: 100%;
                margin: 0;
            }

            .header-search input {
                padding: 12px 50px 12px 18px;
                font-size: 14px;
            }

            .header-search .search-btn {
                padding: 10px 18px;
            }

            .header-actions {
                order: 3;
                width: 100%;
                justify-content: space-between;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .header-action {
                padding: 8px 12px;
                flex: 1;
                min-width: 0;
            }

            .action-label {
                font-size: 9px;
            }

            .action-value {
                font-size: 11px;
            }

            .header-container {
                flex-direction: column;
                gap: 1rem;
                padding: 0.5rem 1rem;
            }

            .search-bar {
                margin: 0;
                max-width: 100%;
                order: 2;
            }

            .section-title {
                font-size: 2rem;
                margin-bottom: 2rem;
            }

            .nav-container {
                flex-direction: column;
                gap: 1rem;
                padding: 0.5rem 1rem;
            }

            .nav-categories {
                justify-content: center;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .nav-categories a {
                font-size: 14px;
                padding: 6px 12px;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .cta-btn {
                padding: 14px 28px;
                font-size: 1rem;
            }

            .main {
                padding: 1.5rem 0.5rem;
            }

            .container {
                padding: 0 0.5rem;
            }

            .recommended-section,
            .categories-section {
                padding: 1.5rem 1rem;
                margin-bottom: 2rem;
                border-radius: 20px;
            }
            
            .categories-section .container {
                padding: 0;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 1rem;
            }

            .product-card {
                border-radius: 15px;
            }

            .product-image {
                height: 200px;
            }

            .product-info {
                padding: 1.2rem;
            }

            .product-title {
                font-size: 1.1rem;
            }

            .product-price {
                font-size: 1.4rem;
            }

            .categories-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 0.8rem;
            }

            .category-card {
                padding: 1rem;
                border-radius: 14px;
                gap: 0.8rem;
            }

            .category-icon {
                font-size: 1.5rem;
                min-width: 40px;
                height: 40px;
                border-radius: 10px;
            }

            .category-card h3 {
                font-size: 0.9rem;
            }

            .product-detail {
                grid-template-columns: 1fr;
            }

            .products-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
                padding: 1rem;
            }

            .filter-tabs {
                justify-content: center;
            }

            .filter-tab {
                padding: 8px 16px;
                font-size: 12px;
            }

            .newsletter-form {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
                margin: 1rem;
            }

            .quick-actions {
                bottom: 20px;
                right: 20px;
            }

            .quick-action-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }

            .products-carousel {
                gap: 1rem;
            }

            .cart-icon-wrapper svg {
                width: 24px;
                height: 16px;
            }
        }

        @media (max-width: 1024px) {
            .header-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .header-nav::-webkit-scrollbar {
                display: none;
            }
            
            .nav-category {
                flex-shrink: 0;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (max-width: 640px) {
            .cabinet-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .settings-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .footer-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .subcategories-menu {
                min-width: 180px;
            }
        }

        @media (max-width: 480px) {
            html, body {
                overflow-x: hidden;
                max-width: 100vw;
            }

            .header {
                padding: 0.6rem 0;
                width: 100%;
                max-width: 100vw;
            }

            .header-top {
                padding: 0.8rem;
                gap: 0.8rem;
                width: 100%;
            }

            .logo-image {
                height: 35px;
            }

            .logo-text {
                font-size: 1.2rem;
            }

            .header-search input {
                padding: 10px 45px 10px 16px;
                font-size: 13px;
            }

            .header-search .search-btn {
                padding: 8px 16px;
            }

            .header-action {
                padding: 6px 10px;
            }

            .action-label {
                font-size: 8px;
            }

            .action-value {
                font-size: 10px;
            }

            .section-title {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .hero h1 {
                font-size: 1.8rem;
            }

            .hero {
                padding: 1.5rem 0.8rem;
            }

            .main {
                padding: 1rem 0.5rem;
            }

            .recommended-section,
            .categories-section {
                padding: 1.2rem 0.8rem;
                margin-bottom: 1.5rem;
                border-radius: 15px;
            }
            
            .categories-section .container {
                padding: 0;
            }

            .products-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .product-image {
                height: 180px;
            }

            .product-info {
                padding: 1rem;
            }

            .product-title {
                font-size: 1rem;
            }

            .product-price {
                font-size: 1.3rem;
            }

            .categories-grid {
                grid-template-columns: 1fr;
                gap: 0.7rem;
            }

            .category-card {
                padding: 0.9rem;
                border-radius: 12px;
                gap: 0.7rem;
            }

            .category-icon {
                font-size: 1.3rem;
                min-width: 36px;
                height: 36px;
                border-radius: 8px;
            }

            .category-card h3 {
                font-size: 0.85rem;
            }

            .filter-tab {
                padding: 6px 12px;
                font-size: 11px;
            }

            .cta-btn {
                padding: 12px 24px;
                font-size: 0.9rem;
            }

            .products-carousel {
                gap: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress" id="scrollProgress"></div>
    
    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()" aria-label="Наверх">↑</button>
    
    <!-- Compare Products Bar -->
    <div class="compare-bar" id="compareBar">
        <div class="compare-items" id="compareItems">
            <span style="font-weight: 500;">Сравнить товары:</span>
            <div id="compareList"></div>
            <button class="compare-btn" onclick="showCompareModal()">Сравнить</button>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div class="header-logo">
                <img src="logo.png" alt="Re - Minko" class="logo-image" onload="this.nextElementSibling.style.display='none';" onerror="this.style.display='none'; if(this.nextElementSibling) { this.nextElementSibling.style.display='block'; this.nextElementSibling.classList.add('logo-text-fallback'); }">
                <span class="logo-text">Re - Minko</span>
            </div>
            
            <div class="header-search">
                <input type="text" placeholder="Поиск товаров на Re - Minko" id="searchInput" oninput="showSearchSuggestions()" onkeypress="if(event.key==='Enter') searchProducts()" onfocus="showSearchSuggestions()" onblur="setTimeout(hideSearchSuggestions, 200)" aria-label="Поиск товаров">
                <button onclick="searchProducts()" aria-label="Найти" class="search-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M19 19L13 13M15 8C15 11.866 11.866 15 8 15C4.13401 15 1 11.866 1 8C1 4.13401 4.13401 1 8 1C11.866 1 15 4.13401 15 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            
            <div class="header-actions">
                <div class="header-action" id="accountMenuTrigger" onclick="if(AppState.currentUser) showAccountMenu(event); else showLoginModal();">
                    <span class="action-label" id="accountLabel">Привет, войдите</span>
                    <span class="action-value" id="accountValue">Аккаунт</span>
                </div>
                
                <div class="header-action add-product-btn" onclick="showSellProductModal()" title="Добавить свой товар">
                    <span class="action-label">Продавать</span>
                    <span class="action-value">на Re - Minko</span>
                </div>
                
                <div class="header-cart header-action" onclick="toggleCart()">
                    <div class="cart-icon-wrapper">
                        <svg width="38" height="26" viewBox="0 0 38 26" fill="none">
                            <path d="M7.5 1L3 6.5V23C3 23.8284 3.67157 24.5 4.5 24.5H33.5C34.3284 24.5 35 23.8284 35 23V6.5L30.5 1H7.5Z" stroke="white" stroke-width="2" fill="none"/>
                            <path d="M3 6.5H35" stroke="white" stroke-width="2"/>
                        </svg>
                        <span id="cartCount" class="cart-count">0</span>
                    </div>
                    <span class="action-value">Корзина</span>
                </div>
            </div>
        </div>
        
        <!-- Categories Navigation - Amazon Style -->
        <div class="header-nav">
            <div class="nav-category" onmouseenter="showSubcategories('electronics', this)" onmouseleave="hideSubcategories(this)">
                <span>📱</span>
                <span>Электроника</span>
                <div class="subcategories-menu" id="electronics-submenu">
                    <div class="subcategory-item" onclick="showCategorySubcategories('electronics', 'phones')">📱 Смартфоны</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('electronics', 'laptops')">💻 Ноутбуки</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('electronics', 'tablets')">📱 Планшеты</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('electronics', 'headphones')">🎧 Наушники</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('electronics', 'cameras')">📷 Фотоаппараты</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('electronics')">Все электроника</div>
                </div>
            </div>
            <div class="nav-category" onmouseenter="showSubcategories('clothing', this)" onmouseleave="hideSubcategories(this)">
                <span>👕</span>
                <span>Одежда</span>
                <div class="subcategories-menu" id="clothing-submenu">
                    <div class="subcategory-item" onclick="showCategorySubcategories('clothing', 'men')">👔 Мужская</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('clothing', 'women')">👗 Женская</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('clothing', 'kids')">👶 Детская</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('clothing', 'shoes')">👟 Обувь</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('clothing', 'accessories')">👜 Аксессуары</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('clothing')">Вся одежда</div>
                </div>
            </div>
            <div class="nav-category" onmouseenter="showSubcategories('home', this)" onmouseleave="hideSubcategories(this)">
                <span>🏠</span>
                <span>Дом и кухня</span>
                <div class="subcategories-menu" id="home-submenu">
                    <div class="subcategory-item" onclick="showCategorySubcategories('home', 'furniture')">🛋️ Мебель</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('home', 'kitchen')">🍳 Кухня</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('home', 'decor')">🖼️ Декор</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('home', 'appliances')">⚡ Техника для дома</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('home', 'garden')">🌳 Сад</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('home')">Весь дом</div>
                </div>
            </div>
            <div class="nav-category" onmouseenter="showSubcategories('sports', this)" onmouseleave="hideSubcategories(this)">
                <span>⚽</span>
                <span>Спорт</span>
                <div class="subcategories-menu" id="sports-submenu">
                    <div class="subcategory-item" onclick="showCategorySubcategories('sports', 'fitness')">💪 Фитнес</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('sports', 'outdoor')">🏕️ Туризм</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('sports', 'water')">🏊 Водный спорт</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('sports', 'winter')">⛷️ Зимний спорт</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('sports')">Весь спорт</div>
                </div>
            </div>
            <div class="nav-category" onmouseenter="showSubcategories('beauty', this)" onmouseleave="hideSubcategories(this)">
                <span>💄</span>
                <span>Красота</span>
                <div class="subcategories-menu" id="beauty-submenu">
                    <div class="subcategory-item" onclick="showCategorySubcategories('beauty', 'cosmetics')">💅 Косметика</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('beauty', 'skincare')">🧴 Уход за кожей</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('beauty', 'perfume')">🌸 Парфюмерия</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('beauty', 'hair')">💇 Уход за волосами</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('beauty')">Вся красота</div>
                </div>
            </div>
            <div class="nav-category" onmouseenter="showSubcategories('books', this)" onmouseleave="hideSubcategories(this)">
                <span>📚</span>
                <span>Книги</span>
                <div class="subcategories-menu" id="books-submenu">
                    <div class="subcategory-item" onclick="showCategorySubcategories('books', 'fiction')">📖 Художественная</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('books', 'business')">💼 Бизнес</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('books', 'tech')">💻 Техническая</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('books', 'children')">📗 Детская</div>
                    <div class="subcategory-item" onclick="showCategorySubcategories('books')">Все книги</div>
                </div>
            </div>
        </div>
        
    </header>



    <!-- Main Content -->
    <main class="main main-with-sidebar" id="mainContent">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs" id="breadcrumbs">
            <a href="#" onclick="showAllProducts(); return false;">Главная</a>
            <span>/</span>
            <span id="breadcrumbCategory">Все товары</span>
        </div>
        
        <!-- First Seller Section -->
        <section class="first-seller-section" style="text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; margin: 2rem 0; color: white;">
            <div class="container">
                <h1 style="font-size: 3rem; margin-bottom: 1rem; font-weight: 700;">🚀 Стань первым продавцом на Re - Minko!</h1>
                <p style="font-size: 1.3rem; margin-bottom: 2rem; opacity: 0.9;">Начни продавать свои товары уже сегодня. Быстрая регистрация, удобный интерфейс, мгновенные выплаты.</p>
                <button class="cta-btn" onclick="showSellProductModal()" style="background: #ff9900; color: white; padding: 1.2rem 3rem; font-size: 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                    📦 Выложить товар
                </button>
            </div>
        </section>
        
        <!-- Products Section (hidden by default, shown when products exist) -->
        <section id="productsSection" style="display: none;">
            <div class="container">
                <div class="product-counter" style="margin-bottom: 1rem; color: #666; font-size: 14px;">Найдено: 0 товаров</div>
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be displayed here -->
                </div>
            </div>
        </section>




    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-section">
                <h3>О нас</h3>
                <ul>
                    <li><a href="#">О компании</a></li>
                    <li><a href="#" onmouseenter="showBlogSubmenu(event)" onmouseleave="hideBlogSubmenu(event)">Блог <span style="font-size: 0.8em;">▼</span></a>
                        <ul id="blogSubmenu" class="blog-submenu" style="display: none; position: absolute; background: #232f3e; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; min-width: 200px;">
                            <li><a href="https://t.me/re_minko_shop" target="_blank" rel="noopener noreferrer">Telegram</a></li>
                            <li><a href="https://tiktok.com/@re.minko" target="_blank" rel="noopener noreferrer">TikTok</a></li>
                            <li><a href="#" target="_blank" rel="noopener noreferrer">Instagram</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Покупателям</h3>
                <ul>
                    <li><a href="#">Как сделать заказ</a></li>
                    <li><a href="#">Способы оплаты</a></li>
                    <li><a href="#">Доставка</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Продавцам</h3>
                <ul>
                    <li><a href="#" onclick="showSellProductModal(); return false;">Продавать на Re - Minko</a></li>
                    <li><a href="#">Комиссия</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Контакты</h3>
                <ul>
                    <li>📧 Email: <a href="mailto:re.minko.shop@gmail.com">re.minko.shop@gmail.com</a></li>
                    <li>💬 Telegram: <a href="https://t.me/re_minko" target="_blank" rel="noopener noreferrer">@re_minko</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p style="margin: 0; padding: 1rem 0; color: #cccccc; font-size: 13px;">
                Re - Minko - Ваш надежный интернет-магазин | Работаем 24/7
            </p>
        </div>
    </footer>


    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Cart Modal -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🛒 Корзина покупок</h3>
                <button class="close-modal" onclick="toggleCart()">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be added here -->
            </div>
            <div class="cart-total" id="cartTotal">
                <h3>Итого: 0 ₽</h3>
                <button class="checkout-btn" onclick="proceedToCheckout()">Оформить заказ</button>
            </div>
        </div>
    </div>

    <!-- Wishlist Modal -->
    <div class="modal" id="wishlistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>❤️ Избранные товары</h3>
                <button class="close-modal" onclick="toggleWishlist()">&times;</button>
            </div>
            <div class="cart-items" id="wishlistItems">
                <!-- Wishlist items will be added here -->
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Детали товара</h3>
                <button class="close-modal" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="product-detail" id="productDetail">
                <!-- Product details will be added here -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вход в аккаунт</h3>
                <button class="close-modal" onclick="closeLoginModal()">&times;</button>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="email" required aria-label="Email для входа">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" name="password" required aria-label="Пароль для входа">
                </div>
                <button type="submit" class="checkout-btn">Войти</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <p style="font-size: 14px; color: #666;">Нет аккаунта? <a href="#" onclick="showRegisterModal(); closeLoginModal();" style="color: #007185; text-decoration: none;">Зарегистрироваться</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Регистрация</h3>
                <button class="close-modal" onclick="closeRegisterModal()">&times;</button>
            </div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="registerName">Имя:</label>
                    <input type="text" id="registerName" name="name" required aria-label="Ваше имя">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" name="email" required aria-label="Email для регистрации">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Пароль:</label>
                    <input type="password" id="registerPassword" name="password" required aria-label="Пароль для регистрации">
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">Подтвердите пароль:</label>
                    <input type="password" id="registerPasswordConfirm" name="passwordConfirm" required aria-label="Подтверждение пароля">
                </div>
                <button type="submit" class="checkout-btn">Зарегистрироваться</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <p style="font-size: 14px; color: #666;">Уже есть аккаунт? <a href="#" onclick="showLoginModal(); closeRegisterModal();" style="color: #007185; text-decoration: none;">Войти</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- User Cabinet Modal -->
    <div class="modal" id="userCabinetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Личный кабинет</h3>
                <button class="close-modal" onclick="closeUserCabinet()">&times;</button>
            </div>
            <div id="userCabinetContent">
                <!-- User cabinet content will be added here -->
            </div>
        </div>
    </div>

    <!-- Delivery Tracking Modal -->
    <div class="modal" id="trackingModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Отслеживание доставки</h3>
                <button class="close-modal" onclick="closeTrackingModal()">&times;</button>
            </div>
            <div id="trackingContent">
                <!-- Tracking content will be added here -->
            </div>
        </div>
    </div>

    <!-- Support Chat Modal -->
    <div class="modal" id="supportChatModal">
        <div class="modal-content" style="max-width: 600px; height: 500px;">
            <div class="modal-header">
                <h3>Чат с поддержкой</h3>
                <button class="close-modal" onclick="closeSupportChat()">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(100% - 80px);">
                <div id="supportMessages" style="flex: 1; overflow-y: auto; padding: 1rem; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 1rem; background: #f8f9fa; max-height: 300px;">
                    <div class="support-message support-message-system">
                        <div class="support-avatar">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="support-content">
                            <p>Здравствуйте! Я виртуальный помощник Re - Minko. Чем могу помочь?</p>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="supportInput" placeholder="Введите ваш вопрос..." style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 4px;" onkeypress="handleSupportKeyPress(event)">
                    <button onclick="sendSupportMessage()" class="checkout-btn">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Product Modal -->
    <div class="modal" id="sellProductModal">
        <div class="modal-content sell-product-modal">
            <div class="modal-header">
                <h3>📦 Продать товар на Re - Minko</h3>
                <button class="close-modal" onclick="closeSellProductModal()">&times;</button>
            </div>
            <form id="sellProductForm" onsubmit="handleSellProduct(event)" class="sell-product-form">
                <div class="form-section">
                    <h4 class="form-section-title">Основная информация</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">Название товара *</label>
                            <input type="text" id="productName" name="productName" required placeholder="Введите название товара" aria-label="Название товара">
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Категория *</label>
                            <select id="productCategory" name="productCategory" required aria-label="Категория товара" title="Выберите категорию товара" onchange="updateSubcategoryOptions()">
                                <option value="">Выберите категорию</option>
                                <option value="electronics">Электроника</option>
                                <option value="clothing">Одежда</option>
                                <option value="home">Дом и кухня</option>
                                <option value="sports">Спорт и отдых</option>
                                <option value="beauty">Красота</option>
                                <option value="books">Книги</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productSubcategory">Подкатегория *</label>
                            <select id="productSubcategory" name="productSubcategory" required aria-label="Подкатегория товара" title="Выберите подкатегорию товара" disabled>
                                <option value="">Сначала выберите категорию</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 class="form-section-title">Цена и количество</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productPrice">Цена (₽) *</label>
                            <input type="number" id="productPrice" name="productPrice" required min="0" step="0.01" placeholder="0.00" aria-label="Цена товара">
                        </div>
                        <div class="form-group">
                            <label for="productStock">Количество *</label>
                            <input type="number" id="productStock" name="productStock" required min="1" placeholder="1" aria-label="Количество товара">
                        </div>
                        <div class="form-group">
                            <label for="productDiscount">Скидка (%)</label>
                            <input type="number" id="productDiscount" name="productDiscount" min="0" max="100" value="0" placeholder="0" aria-label="Скидка в процентах">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 class="form-section-title">Описание товара</h4>
                    <div class="form-group">
                        <label for="productDescription">Описание *</label>
                        <textarea id="productDescription" name="productDescription" required rows="5" placeholder="Опишите ваш товар подробно..." aria-label="Описание товара"></textarea>
                        <small class="form-hint">Опишите характеристики, преимущества и особенности товара</small>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 class="form-section-title">Медиа материалы</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productImages">Фото товара</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="productImages" name="productImages" multiple accept="image/*" aria-label="Загрузить фото товара" onchange="previewProductImages(event)">
                                <p class="form-hint">Можно загрузить до 10 фотографий. Форматы: JPG, PNG, WEBP</p>
                                <span class="file-input-label">Выберите фото</span>
                            </div>
                            <small class="form-hint">Можно загрузить несколько фото (до 10 файлов)</small>
                            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                                <div class="image-preview-grid" id="imagePreviewGrid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeSellProductModal()">Отмена</button>
                    <button type="submit" class="btn-primary">🚀 Опубликовать товар</button>
                </div>
            </form>
        </div>
    </div>

    <!-- My Products Modal -->
    <div class="modal" id="myProductsModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3>Мои товары</h3>
                <button class="close-modal" onclick="closeMyProductsModal()">&times;</button>
            </div>
            <div id="myProductsContent">
                <!-- My products content will be added here -->
            </div>
        </div>
    </div>

    <!-- Sales Stats Modal -->
    <div class="modal" id="salesStatsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Статистика продаж</h3>
                <button class="close-modal" onclick="closeSalesStatsModal()">&times;</button>
            </div>
            <div id="salesStatsContent">
                <!-- Sales stats content will be added here -->
            </div>
        </div>
    </div>

    <!-- Payment Methods Modal -->
    <div class="modal" id="paymentMethodsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Способы оплаты</h3>
                <button class="close-modal" onclick="closePaymentMethodsModal()">&times;</button>
            </div>
            <div id="paymentMethodsContent">
                <div style="margin-bottom: 2rem;">
                    <h4>Добавить способ оплаты</h4>
                    <form onsubmit="addPaymentMethod(event)">
                        <div style="margin-bottom: 1rem;">
                            <label for="paymentType">Тип карты/кошелька</label>
                            <select id="paymentType" name="paymentType" required style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" aria-label="Тип карты или кошелька" title="Выберите тип карты или кошелька">
                                <option value="">Выберите тип</option>
                                <option value="mastercard">Mastercard</option>
                                <option value="visa">Visa</option>
                                <option value="bitcoin">Bitcoin</option>
                                <option value="ethereum">Ethereum</option>
                                <option value="usdt">USDT (Tether)</option>
                                <option value="escrow">Оплата на личный счет (эскроу)</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="paymentAddress">Номер карты/Адрес кошелька</label>
                            <input type="text" id="paymentAddress" name="paymentAddress" required style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Введите номер карты или адрес кошелька" aria-label="Номер карты или адрес кошелька">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="cardHolder">Имя владельца (для карт)</label>
                            <input type="text" id="cardHolder" name="cardHolder" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Имя на карте" aria-label="Имя владельца карты">
                        </div>
                        <button type="submit" class="checkout-btn">Добавить</button>
                    </form>
                </div>
                
                <div>
                    <h4>Мои способы оплаты</h4>
                    <div id="paymentMethodsList">
                        <!-- Payment methods will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal" id="chatModal">
        <div class="modal-content" style="max-width: 800px; height: 600px;">
            <div class="modal-header">
                <h3 id="chatTitle">Чат с продавцом</h3>
                <button class="close-modal" onclick="closeChatModal()">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(100% - 80px);">
                <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 1rem; background: #f9f9f9;">
                    <!-- Chat messages will be added here -->
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Введите сообщение..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()" class="checkout-btn">Отправить</button>
                </div>
                <div id="chatActions" style="margin-top: 1rem; display: none;">
                    <button onclick="confirmPayment()" class="checkout-btn" style="background: #4CAF50;">Подтвердить оплату</button>
                    <button onclick="confirmDelivery()" class="checkout-btn" style="background: #2196F3;">Подтвердить получение</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Escrow Payment Modal -->
    <div class="modal" id="escrowPaymentModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Оплата через эскроу</h3>
                <button class="close-modal" onclick="closeEscrowPaymentModal()">&times;</button>
            </div>
            <div id="escrowPaymentContent">
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <h4>Как работает эскроу:</h4>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Вы переводите деньги на счет сайта</li>
                        <li>Средства замораживаются до получения товара</li>
                        <li>После подтверждения получения деньги переводятся продавцу</li>
                        <li>Это защищает от мошенничества</li>
                    </ul>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="escrowAmount">Сумма к оплате:</label>
                    <input type="number" id="escrowAmount" name="escrowAmount" readonly style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;" aria-label="Сумма к оплате через эскроу">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="escrowPaymentMethod">Ваш способ оплаты:</label>
                    <select id="escrowPaymentMethod" name="escrowPaymentMethod" required style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" aria-label="Способ оплаты через эскроу" title="Выберите способ оплаты">
                        <option value="">Выберите способ оплаты</option>
                    </select>
                </div>
                <button onclick="processEscrowPayment()" class="checkout-btn">Оплатить через эскроу</button>
            </div>
        </div>
    </div>

    <!-- JavaScript код -->
    <script>
        // Products database - будет загружена из Supabase
        let products = [];
        
        // Initial products (пусто - товары добавляются продавцами)
        const initialProducts = [];

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        let filteredProducts = [...products];
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let userProducts = JSON.parse(localStorage.getItem('userProducts')) || [];
        let sidebarOpen = false;
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let siteCommission = 0.03; // 3% комиссия
        let paymentMethods = JSON.parse(localStorage.getItem('paymentMethods')) || [];
        let escrowBalance = JSON.parse(localStorage.getItem('escrowBalance')) || 0; // Замороженные средства
        let chats = JSON.parse(localStorage.getItem('chats')) || [];
        let currentChat = null;

        // AppState для управления состоянием приложения
        const AppState = {
            currentUser: null,
            get currentUser() {
                return JSON.parse(localStorage.getItem('currentUser')) || null;
            },
            set currentUser(user) {
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    localStorage.removeItem('currentUser');
                }
            }
        };

        // Initialize the page - moved to end of script

        // Display products
        function displayProducts(productsToShow) {
            const productsGrid = document.getElementById('productsGrid');
            const productsSection = document.getElementById('productsSection');
            const firstSellerSection = document.querySelector('.first-seller-section');
            
            if (!productsGrid) return;
            
            // Показываем секцию товаров только если есть товары
            if (productsToShow.length > 0 && productsSection) {
                productsSection.style.display = 'block';
                // Скрываем секцию "Стань первым продавцом" когда есть товары
                if (firstSellerSection) {
                    firstSellerSection.style.display = 'none';
                }
            } else {
                if (productsSection) productsSection.style.display = 'none';
                // Показываем секцию "Стань первым продавцом" когда нет товаров
                if (firstSellerSection) {
                    firstSellerSection.style.display = 'block';
                }
            }
            
            productsGrid.innerHTML = '';

            if (productsToShow.length === 0) {
                // Показываем сообщение о том, что товаров нет
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-products-message';
                emptyMessage.style.cssText = 'text-align: center; padding: 4rem 2rem; background: #f8f9fa; border-radius: 12px; margin: 2rem 0;';
                emptyMessage.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 1rem;">📦</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #0f1111;">Товаров в этой категории пока нет</h3>
                    <p style="color: #666; margin-bottom: 2rem; font-size: 1rem;">Станьте первым продавцом и выложите свой товар!</p>
                    <button onclick="showSellProductModal()" class="btn-primary" style="background: #ff9900; color: white; padding: 1rem 2rem; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        📦 Выложить товар
                    </button>
                `;
                productsGrid.appendChild(emptyMessage);
                return;
            }

            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                const badgeHtml = product.badge ? `<div class="product-badge ${product.badge}">${getBadgeText(product.badge)}</div>` : '';
                const originalPriceHtml = product.originalPrice ? `<span class="old-price">${product.originalPrice.toLocaleString()} ₽</span>` : '';
                
                // Используем загруженное изображение или placeholder
                const productImage = (product.images && product.images.length > 0) ? product.images[0] : 
                                    (product.image && product.image.startsWith('data:image')) ? product.image :
                                    (product.image && !product.image.startsWith('📦') && !product.image.startsWith('📱') && !product.image.startsWith('💻')) ? product.image :
                                    getProductImageUrl(product.category, product.name);
                
                const isInWishlist = wishlist.some(w => w.id === product.id);
                const isInCompare = compareList.some(c => c.id === product.id);
                const rating = product.rating || Math.floor(Math.random() * 2) + 3; // Random rating 3-5
                const reviewCount = Math.floor(Math.random() * 500) + 10;
                
                productCard.innerHTML = `
                    ${badgeHtml}
                    <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" onclick="toggleWishlist(${product.id}, event)" title="${isInWishlist ? 'Удалить из избранного' : 'Добавить в избранное'}">
                        ${isInWishlist ? '❤️' : '🤍'}
                    </button>
                    <div class="product-image" style="background-image: url('${productImage}'); background-size: cover; background-position: center;" onclick="showProductDetail(${product.id})">
                        ${productImage.startsWith('data:image') ? `<img src="${productImage}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; display: block;">` : 
                          productImage.startsWith('http') ? `<img src="${productImage}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; display: block;" onerror="this.parentElement.innerHTML='${product.image || '📦'}'; this.parentElement.style.display='flex'; this.parentElement.style.alignItems='center'; this.parentElement.style.justifyContent='center'; this.parentElement.style.fontSize='4rem';">` :
                          `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 4rem;">${product.image || '📦'}</div>`}
                    </div>
                    <div class="product-actions">
                        <button class="product-action-btn" onclick="quickView(${product.id})" title="Быстрый просмотр">👁️</button>
                        <button class="product-action-btn ${isInCompare ? 'active' : ''}" onclick="toggleCompare(${product.id}, event)" title="${isInCompare ? 'Удалить из сравнения' : 'Сравнить'}">⚖️</button>
                        ${product.sellerId ? `<button class="product-action-btn" onclick="openChat(${product.sellerId}, ${product.id})" title="Написать продавцу">💬</button>` : ''}
                    </div>
                    <div class="product-info">
                        <div class="product-rating-display">
                            <span class="stars-filled">${'★'.repeat(rating)}${'☆'.repeat(5-rating)}</span>
                            <span class="rating-number">(${reviewCount})</span>
                        </div>
                        <h3 class="product-title" onclick="showProductDetail(${product.id})">${product.name}</h3>
                        <p class="product-description">${product.description.substring(0, 80)}${product.description.length > 80 ? '...' : ''}</p>
                        <div class="product-price">
                            ${product.price.toLocaleString()} ₽
                            ${originalPriceHtml}
                        </div>
                        <div class="product-buttons">
                            <button class="add-to-cart" onclick="addToCart(${product.id})">В корзину</button>
                            <button class="buy-now" onclick="buyNow(${product.id})">Купить</button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
            
            // Update counter after displaying
            updateProductCounter();
        }

        // Get badge text
        function getBadgeText(badge) {
            const badges = {
                'new': 'Новинка',
                'sale': 'Скидка',
                'hot': 'Хит',
                'bestseller': 'Бестселлер'
            };
            return badges[badge] || badge;
        }

        // Get product image URL
        function getProductImageUrl(category, productName) {
            const imageMap = {
                'electronics': 'https://picsum.photos/400/300?random=1',
                'clothing': 'https://picsum.photos/400/300?random=2',
                'home': 'https://picsum.photos/400/300?random=3',
                'sports': 'https://picsum.photos/400/300?random=4',
                'beauty': 'https://picsum.photos/400/300?random=5',
                'books': 'https://picsum.photos/400/300?random=6',
                'toys': 'https://picsum.photos/400/300?random=7',
                'auto': 'https://picsum.photos/400/300?random=8'
            };
            return imageMap[category] || 'https://picsum.photos/400/300?random=9';
        }

        // Add to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден', 'error');
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                } else {
                    showNotification('Товар закончился на складе', 'warning');
                    return;
                }
            } else {
                cart.push({...product, quantity: 1});
            }
            
            // Сохраняем корзину в localStorage
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            showNotification('Товар добавлен в корзину!', 'success');
        }

        // Add to wishlist
        function addToWishlist(productId) {
            const product = products.find(p => p.id === productId);
            const existingItem = wishlist.find(item => item.id === productId);
            
            if (existingItem) {
                wishlist = wishlist.filter(item => item.id !== productId);
                showNotification('Товар удален из избранного', 'info');
            } else {
                wishlist.push(product);
                showNotification('Товар добавлен в избранное!', 'success');
            }
            
            updateWishlistDisplay();
        }

        // Update cart display
        function updateCartDisplay() {
            const cartCount = document.getElementById('cartCount');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;

            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="cart-empty">
                        <div class="cart-empty-icon">🛒</div>
                        <p class="cart-empty-text">Ваша корзина пуста</p>
                        <p class="cart-empty-subtext">Добавьте товары, чтобы начать покупки</p>
                    </div>
                `;
                cartTotal.innerHTML = `
                    <div class="cart-summary">
                        <div class="cart-summary-row">
                            <span>Товаров:</span>
                            <span>0</span>
                        </div>
                        <div class="cart-summary-row total">
                            <span>Итого:</span>
                            <span>0 ₽</span>
                        </div>
                    </div>
                    <button class="checkout-btn" disabled>Оформить заказ</button>
                `;
                return;
            }

            let total = 0;
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                // Получаем изображение товара
                const itemImage = (item.images && item.images.length > 0) ? item.images[0] : 
                                 (item.image && item.image.startsWith('data:image')) ? item.image :
                                 (item.image && !item.image.startsWith('📦') && !item.image.startsWith('📱') && !item.image.startsWith('💻')) ? item.image :
                                 '📦';
                
                const imageHtml = itemImage.startsWith('data:image') ? 
                    `<img src="${itemImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` :
                    itemImage.startsWith('http') ?
                    `<img src="${itemImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" onerror="this.parentElement.innerHTML='${item.image || '📦'}'; this.parentElement.style.display='flex'; this.parentElement.style.alignItems='center'; this.parentElement.style.justifyContent='center'; this.parentElement.style.fontSize='2rem';">` :
                    `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2rem;">${itemImage}</div>`;
                
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-image">${imageHtml}</div>
                        <div class="cart-item-details">
                            <h4>${item.name}</h4>
                            <p class="cart-item-price">${item.price.toLocaleString()} ₽ за шт.</p>
                            ${item.sellerName ? `<p class="cart-item-seller">Продавец: ${item.sellerName}</p>` : ''}
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.stock}" onchange="updateQuantity(${item.id}, parseInt(this.value) || 1)">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})" ${item.quantity >= item.stock ? 'disabled' : ''}>+</button>
                        </div>
                        <div class="cart-item-total">
                            <div class="cart-item-total-price">${itemTotal.toLocaleString()} ₽</div>
                            <button class="remove-item-btn" onclick="removeFromCart(${item.id})" title="Удалить из корзины">🗑️</button>
                        </div>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            const commission = total * siteCommission;
            const totalWithCommission = total + commission;
            
            cartTotal.innerHTML = `
                <div class="cart-summary">
                    <div class="cart-summary-row">
                        <span>Товаров (${totalItems}):</span>
                        <span>${total.toLocaleString()} ₽</span>
                    </div>
                    <div class="cart-summary-row">
                        <span>Комиссия сайта:</span>
                        <span>${commission.toLocaleString()} ₽</span>
                    </div>
                    <div class="cart-summary-row total">
                        <span>Итого к оплате:</span>
                        <span class="cart-total-amount">${totalWithCommission.toLocaleString()} ₽</span>
                    </div>
                </div>
                <button class="checkout-btn" onclick="proceedToCheckout()">Оформить заказ</button>
            `;
        }

        // Update wishlist display
        function updateWishlistDisplay() {
            const wishlistCount = document.getElementById('wishlistCount');
            wishlistCount.textContent = wishlist.length;

            const wishlistItems = document.getElementById('wishlistItems');
            wishlistItems.innerHTML = '';
            
            if (wishlist.length === 0) {
                wishlistItems.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Список избранного пуст</p>';
                return;
            }

            wishlist.forEach(item => {
                const wishlistItem = document.createElement('div');
                wishlistItem.className = 'cart-item';
                
                // Получаем изображение товара
                const itemImage = (item.images && item.images.length > 0) ? item.images[0] : 
                                 (item.image && item.image.startsWith('data:image')) ? item.image :
                                 (item.image && !item.image.startsWith('📦') && !item.image.startsWith('📱') && !item.image.startsWith('💻')) ? item.image :
                                 '📦';
                
                const imageHtml = itemImage.startsWith('data:image') ? 
                    `<img src="${itemImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` :
                    itemImage.startsWith('http') ?
                    `<img src="${itemImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" onerror="this.parentElement.innerHTML='${item.image || '📦'}'; this.parentElement.style.display='flex'; this.parentElement.style.alignItems='center'; this.parentElement.style.justifyContent='center'; this.parentElement.style.fontSize='2rem';">` :
                    `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2rem;">${itemImage}</div>`;
                
                wishlistItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-image">${imageHtml}</div>
                        <div class="cart-item-details">
                            <h4>${item.name}</h4>
                            <p>${item.price.toLocaleString()} ₽</p>
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="add-to-cart" onclick="addToCart(${item.id})" style="margin-right: 10px;">В корзину</button>
                        <button class="remove-item" onclick="removeFromWishlist(${item.id})">Удалить</button>
                    </div>
                `;
                wishlistItems.appendChild(wishlistItem);
            });
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            showNotification('Товар удален из корзины', 'info');
        }

        // Remove from wishlist
        function removeFromWishlist(productId) {
            wishlist = wishlist.filter(item => item.id !== productId);
            updateWishlistDisplay();
            showNotification('Товар удален из избранного', 'info');
        }

        // Update quantity
        function updateQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (newQuantity > product.stock) {
                showNotification('Недостаточно товара на складе', 'warning');
                return;
            }
            
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = newQuantity;
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }
        }

        // Toggle cart modal
        function toggleCart() {
            const cartModal = document.getElementById('cartModal');
            cartModal.style.display = cartModal.style.display === 'block' ? 'none' : 'block';
            updateCartDisplay();
        }

        // Toggle wishlist modal
        function toggleWishlist() {
            const wishlistModal = document.getElementById('wishlistModal');
            wishlistModal.style.display = wishlistModal.style.display === 'block' ? 'none' : 'block';
            updateWishlistDisplay();
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Search history management
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];
        const MAX_SEARCH_HISTORY = 10;

        function saveSearchQuery(query) {
            if (!query || query.trim().length < 2) return;
            
            const trimmedQuery = query.trim();
            // Remove if already exists
            searchHistory = searchHistory.filter(q => q.toLowerCase() !== trimmedQuery.toLowerCase());
            // Add to beginning
            searchHistory.unshift(trimmedQuery);
            // Keep only last MAX_SEARCH_HISTORY items
            searchHistory = searchHistory.slice(0, MAX_SEARCH_HISTORY);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        function getSearchHistory() {
            return searchHistory;
        }

        function clearSearchHistory() {
            searchHistory = [];
            localStorage.removeItem('searchHistory');
        }

        // Search products
        function searchProducts() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                showNotification('Введите поисковый запрос', 'warning');
                return;
            }

            // Save search query
            saveSearchQuery(searchTerm);
            
            showLoading();
            setTimeout(() => {
                try {
                    const searchTermLower = searchTerm.toLowerCase();
                    filteredProducts = products.filter(product => 
                        product.name.toLowerCase().includes(searchTermLower) ||
                        product.description.toLowerCase().includes(searchTermLower) ||
                        product.category.toLowerCase().includes(searchTermLower) ||
                        (product.subcategory && product.subcategory.toLowerCase().includes(searchTermLower))
                    );
                    
                    if (filteredProducts.length === 0) {
                        showNotification('Товары не найдены', 'info');
                    }
                    
                    displayProducts(filteredProducts);
                    updateBreadcrumbs('search', null, searchTerm);
                    updateProductCounter();
                } catch (error) {
                    console.error('Search error:', error);
                    showNotification('Ошибка при поиске товаров', 'error');
                } finally {
                    hideLoading();
                }
            }, 200);
        }

        // Show search suggestions
        function showSearchSuggestions() {
            const searchInput = document.getElementById('searchInput');
            const suggestions = document.getElementById('searchSuggestions');
            
            if (!searchInput || !suggestions) return;
            
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm.length === 0) {
                // Show search history
                const history = getSearchHistory();
                if (history.length > 0) {
                    suggestions.innerHTML = `
                        <div class="suggestions-header">
                            <span>Недавние запросы</span>
                            <button class="clear-history-btn" onclick="clearSearchHistory(); showSearchSuggestions();" title="Очистить историю">×</button>
                        </div>
                        ${history.slice(0, 5).map(query => 
                            `<div class="suggestion-item history-item" onclick="selectHistoryQuery('${query.replace(/'/g, "\\'")}')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M7 12L2 7L7 2M14 7L2 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                <span>${query}</span>
                            </div>`
                        ).join('')}
                    `;
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
                return;
            }
            
            if (searchTerm.length < 2) {
                suggestions.style.display = 'none';
                return;
            }

            try {
                const matchingProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm)
                ).slice(0, 5);

                const matchingHistory = searchHistory.filter(query => 
                    query.toLowerCase().includes(searchTerm) && 
                    query.toLowerCase() !== searchTerm
                ).slice(0, 3);

                if (matchingProducts.length > 0 || matchingHistory.length > 0) {
                    let html = '';
                    
                    if (matchingHistory.length > 0) {
                        html += matchingHistory.map(query => 
                            `<div class="suggestion-item history-item" onclick="selectHistoryQuery('${query.replace(/'/g, "\\'")}')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M7 12L2 7L7 2M14 7L2 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                <span>${query}</span>
                            </div>`
                        ).join('');
                    }
                    
                    if (matchingProducts.length > 0) {
                        html += matchingProducts.map(product => 
                            `<div class="suggestion-item" onclick="selectSuggestion('${product.name.replace(/'/g, "\\'")}')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04 1.062.062 1.398.062v.001l.001-.001zm-3.5 1.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z" fill="currentColor"/></svg>
                                <div>
                                    <strong>${product.name}</strong>
                                    <small>${product.price.toLocaleString()} ₽</small>
                                </div>
                            </div>`
                        ).join('');
                    }
                    
                    suggestions.innerHTML = html;
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Suggestions error:', error);
                suggestions.style.display = 'none';
            }
        }

        function selectHistoryQuery(query) {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = query;
                searchProducts();
            }
        }

        // Hide search suggestions
        function hideSearchSuggestions() {
            setTimeout(() => {
                document.getElementById('searchSuggestions').style.display = 'none';
            }, 200);
        }

        // Select suggestion
        function selectSuggestion(productName) {
            document.getElementById('searchInput').value = productName;
            document.getElementById('searchSuggestions').style.display = 'none';
            searchProducts();
        }

        // Filter by category
        function filterByCategory(category) {
            showLoading();
            setTimeout(() => {
                try {
                    filteredProducts = products.filter(product => product.category === category);
                    displayProducts(filteredProducts);
                    updateProductCounter();
                    updateBreadcrumbs(category, null, '');
                    scrollToProducts();
                    hideLoading();
                    
                    if (filteredProducts.length === 0) {
                        showNotification('Товары в этой категории не найдены', 'info');
                    }
                    
                    // Close sidebar
                    if (sidebarOpen) {
                        toggleSidebar();
                    }
                } catch (error) {
                    console.error('Filter error:', error);
                    hideLoading();
                    showNotification('Ошибка при фильтрации', 'error');
                }
            }, 300);
        }

        // Filter products
        function filterProducts(filter) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(filter) {
                case 'sale':
                    filteredProducts = products.filter(p => p.originalPrice && p.originalPrice > p.price);
                    break;
                case 'new':
                    filteredProducts = products.filter(p => p.badge === 'new');
                    break;
                case 'bestsellers':
                    filteredProducts = products.filter(p => p.badge === 'bestseller' || p.rating >= 4.5);
                    break;
                default:
                    filteredProducts = [...products];
            }
            displayProducts(filteredProducts);
        }

        // Sort products
        function sortProducts(sortBy) {
            switch(sortBy) {
                case 'price-low':
                    filteredProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    filteredProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'rating':
                    filteredProducts.sort((a, b) => b.rating - a.rating);
                    break;
                case 'newest':
                    filteredProducts.sort((a, b) => b.id - a.id);
                    break;
                default:
                    filteredProducts.sort((a, b) => b.rating - a.rating);
            }
            displayProducts(filteredProducts);
        }

        // Show product detail
        function showProductDetail(productId) {
            const product = products.find(p => p.id === productId);
            const productDetail = document.getElementById('productDetail');
            
            const originalPriceHtml = product.originalPrice ? `<span class="old-price">${product.originalPrice.toLocaleString()} ₽</span>` : '';
            
            // Получаем реальное изображение товара
            const productImage = (product.images && product.images.length > 0) ? product.images[0] : 
                                (product.image && product.image.startsWith('data:image')) ? product.image :
                                (product.image && !product.image.startsWith('📦') && !product.image.startsWith('📱') && !product.image.startsWith('💻')) ? product.image :
                                getProductImageUrl(product.category, product.name);
            
            const imageHtml = productImage.startsWith('data:image') ? 
                `<img src="${productImage}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 15px;">` :
                productImage.startsWith('http') ?
                `<img src="${productImage}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 15px;" onerror="this.parentElement.innerHTML='${product.image || '📦'}'; this.parentElement.style.display='flex'; this.parentElement.style.alignItems='center'; this.parentElement.style.justifyContent='center'; this.parentElement.style.fontSize='6rem'; this.parentElement.style.color='#ccc';">` :
                `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 6rem; color: #ccc;">${productImage}</div>`;
            
            productDetail.innerHTML = `
                <div class="product-detail-image" style="background-image: ${productImage.startsWith('data:image') || productImage.startsWith('http') ? `url('${productImage}')` : 'none'}; background-size: cover; background-position: center;">
                    ${imageHtml}
                </div>
                <div class="product-detail-info">
                    <h2>${product.name}</h2>
                    <div class="product-detail-price">
                        ${product.price.toLocaleString()} ₽
                        ${originalPriceHtml}
                    </div>
                    <div class="product-rating" style="margin-bottom: 1rem;">
                        <span class="stars">${'★'.repeat(product.rating)}${'☆'.repeat(5-product.rating)}</span>
                        <span class="rating-count">(${product.rating})</span>
                    </div>
                    <p class="product-detail-description">${product.description}</p>
                    <p><strong>В наличии:</strong> ${product.stock} шт.</p>
                    <div class="product-detail-actions">
                        <button class="add-to-cart" onclick="addToCart(${product.id}); closeProductModal();">В корзину</button>
                        <button class="buy-now" onclick="buyNow(${product.id}); closeProductModal();">Купить сейчас</button>
                    </div>
                </div>
            `;
            
            document.getElementById('productModal').style.display = 'block';
        }

        // Close product modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // Buy now
        function buyNow(productId) {
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт для покупки', 'warning');
                showLoginModal();
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден', 'error');
                return;
            }
            
            if (!product.sellerId) {
                showNotification('Продавец не указан для этого товара', 'error');
                return;
            }
            
            // Открываем чат с продавцом
            openChat(product.sellerId, productId);
            
            // Добавляем товар в корзину для истории
            addToCart(productId);
        }

        // Compare product
        function compareProduct(productId) {
            showNotification('Функция сравнения товаров в разработке', 'info');
        }

        // Proceed to checkout
        async function proceedToCheckout() {
            if (cart.length === 0) {
                showNotification('Корзина пуста', 'warning');
                return;
            }
            
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт', 'warning');
                showLoginModal();
                return;
            }
            
            // Check if user has payment methods
            const userPaymentMethods = paymentMethods.filter(pm => pm.userId === currentUser.id);
            if (userPaymentMethods.length === 0) {
                showNotification('Необходимо добавить способ оплаты в профиле', 'warning');
                showPaymentMethods();
                return;
            }
            
            // Calculate total and commission
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const commission = subtotal * siteCommission;
            const total = subtotal + commission;
            
            // Generate tracking number
            const trackingNumber = 'RM' + Date.now().toString().slice(-10) + Math.random().toString(36).substr(2, 5).toUpperCase();
            
            // Create order with tracking
            const order = {
                id: Date.now(),
                trackingNumber: trackingNumber,
                buyerId: currentUser.id,
                buyerName: currentUser.name,
                items: cart.map(item => ({
                    productId: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    sellerId: item.sellerId || 'admin',
                    sellerName: item.sellerName || 'M i n k o'
                })),
                subtotal: subtotal,
                commission: commission,
                total: total,
                status: 'pending',
                createdAt: new Date().toISOString(),
                paymentMethod: 'card', // Default
                delivery: {
                    status: 'pending',
                    trackingNumber: trackingNumber,
                    carrier: 'Re - Minko Delivery',
                    estimatedDelivery: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days
                    trackingHistory: [{
                        status: 'pending',
                        message: 'Заказ создан',
                        timestamp: new Date().toISOString(),
                        location: 'Склад Re - Minko'
                    }]
                }
            };
            
            // Calculate seller amounts
            const sellerGroups = {};
            order.items.forEach(item => {
                if (!sellerGroups[item.sellerId]) {
                    sellerGroups[item.sellerId] = {
                        sellerId: item.sellerId,
                        sellerName: item.sellerName,
                        amount: 0,
                        items: []
                    };
                }
                sellerGroups[item.sellerId].amount += item.price * item.quantity;
                sellerGroups[item.sellerId].items.push(item);
            });
            
            // Add seller amounts to order
            order.sellers = Object.values(sellerGroups).map(seller => ({
                ...seller,
                sellerAmount: seller.amount * (1 - siteCommission),
                sellerCommission: seller.amount * siteCommission
            }));
            
            try {
                showLoading();
                
                // Save order to database
                await saveOrderToDB(order);
                
                // Add to local array
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // Simulate payment processing
                processPayment(order);
                
                // Clear cart
                cart = [];
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
                
                hideLoading();
                showNotification(`Заказ оформлен! Номер отслеживания: ${order.trackingNumber}`, 'success');
                toggleCart();
            } catch (error) {
                hideLoading();
                console.error('Error saving order:', error);
                showNotification('Ошибка при оформлении заказа. Попробуйте позже.', 'error');
            }
        }

        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        // Close login modal
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // Show register modal
        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'block';
        }

        // Close register modal
        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }

        // Validation utilities
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePassword(password) {
            return password && password.length >= 6;
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>]/g, '');
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Remove existing error
            const existingError = field.parentElement.querySelector('.field-error');
            if (existingError) existingError.remove();
            
            // Add error styling
            field.style.borderColor = '#dc3545';
            
            // Add error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            errorDiv.style.cssText = 'color: #dc3545; font-size: 12px; margin-top: 0.25rem;';
            errorDiv.textContent = message;
            field.parentElement.appendChild(errorDiv);
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            field.style.borderColor = '';
            const error = field.parentElement.querySelector('.field-error');
            if (error) error.remove();
        }

        // Handle login with validation
        function handleLogin(event) {
            event.preventDefault();
            
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            
            if (!emailInput || !passwordInput) {
                showNotification('Ошибка: форма не найдена', 'error');
                return;
            }
            
            const email = sanitizeInput(emailInput.value);
            const password = passwordInput.value;
            
            // Clear previous errors
            clearFieldError('loginEmail');
            clearFieldError('loginPassword');
            
            // Validation
            let hasErrors = false;
            
            if (!email) {
                showFieldError('loginEmail', 'Введите email');
                hasErrors = true;
            } else if (!validateEmail(email)) {
                showFieldError('loginEmail', 'Введите корректный email');
                hasErrors = true;
            }
            
            if (!password) {
                showFieldError('loginPassword', 'Введите пароль');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            try {
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
                if (user) {
                    currentUser = user;
                    AppState.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showNotification('Вход выполнен успешно!', 'success');
                    closeLoginModal();
                    updateUserInterface();
                } else {
                    showNotification('Неверный email или пароль', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Ошибка при входе. Попробуйте позже.', 'error');
            }
        }

        // Handle register with validation
        async function handleRegister(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('registerName');
            const emailInput = document.getElementById('registerEmail');
            const passwordInput = document.getElementById('registerPassword');
            const passwordConfirmInput = document.getElementById('registerPasswordConfirm');
            
            if (!nameInput || !emailInput || !passwordInput || !passwordConfirmInput) {
                showNotification('Ошибка: форма не найдена', 'error');
                return;
            }
            
            const name = sanitizeInput(nameInput.value);
            const email = sanitizeInput(emailInput.value);
            const password = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;
            
            // Clear previous errors
            clearFieldError('registerName');
            clearFieldError('registerEmail');
            clearFieldError('registerPassword');
            clearFieldError('registerPasswordConfirm');
            
            // Validation
            let hasErrors = false;
            
            if (!name || name.length < 2) {
                showFieldError('registerName', 'Имя должно содержать минимум 2 символа');
                hasErrors = true;
            }
            
            if (!email) {
                showFieldError('registerEmail', 'Введите email');
                hasErrors = true;
            } else if (!validateEmail(email)) {
                showFieldError('registerEmail', 'Введите корректный email');
                hasErrors = true;
            } else if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) {
                showFieldError('registerEmail', 'Пользователь с таким email уже существует');
                hasErrors = true;
            }
            
            if (!password) {
                showFieldError('registerPassword', 'Введите пароль');
                hasErrors = true;
            } else if (!validatePassword(password)) {
                showFieldError('registerPassword', 'Пароль должен содержать минимум 6 символов');
                hasErrors = true;
            }
            
            if (!passwordConfirm) {
                showFieldError('registerPasswordConfirm', 'Подтвердите пароль');
                hasErrors = true;
            } else if (password !== passwordConfirm) {
                showFieldError('registerPasswordConfirm', 'Пароли не совпадают');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            try {
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email.toLowerCase(),
                    password: password, // В реальном приложении нужно хешировать!
                    createdAt: new Date().toISOString(),
                    orders: [],
                    addresses: []
                };
                
                try {
                    showLoading();
                    
                    // Save user to database
                    const savedUser = await saveUserToDB(newUser);
                    
                    // Add to local array
                    users.push(savedUser || newUser);
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    currentUser = savedUser || newUser;
                    AppState.currentUser = currentUser;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    hideLoading();
                    showNotification('Регистрация успешна!', 'success');
                    closeRegisterModal();
                    updateUserInterface();
                } catch (error) {
                    hideLoading();
                    console.error('Registration error:', error);
                    showNotification('Ошибка при регистрации. Попробуйте позже.', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Ошибка при регистрации. Попробуйте позже.', 'error');
            }
        }

        // Update user interface
        function updateUserInterface() {
            const accountLabel = document.getElementById('accountLabel');
            const accountValue = document.getElementById('accountValue');
            
            if (currentUser) {
                if (accountLabel) accountLabel.textContent = 'Привет, ' + currentUser.name.split(' ')[0];
                if (accountValue) accountValue.textContent = 'Аккаунт';
            } else {
                if (accountLabel) accountLabel.textContent = 'Привет, войдите';
                if (accountValue) accountValue.textContent = 'Аккаунт';
            }
        }

        // Show user cabinet
        function showUserCabinet() {
            const userOrders = orders.filter(order => order.buyerId === currentUser.id);
            const userProducts = products.filter(p => p.sellerId === currentUser.id);
            const userSales = orders.filter(order => order.sellers && order.sellers.some(s => s.sellerId === currentUser.id));
            const totalSpent = userOrders.reduce((sum, order) => sum + order.total, 0);
            const totalEarned = userSales.reduce((sum, order) => {
                const seller = order.sellers.find(s => s.sellerId === currentUser.id);
                return sum + (seller ? seller.sellerAmount : 0);
            }, 0);
            const totalCommission = userSales.reduce((sum, order) => {
                const seller = order.sellers.find(s => s.sellerId === currentUser.id);
                return sum + (seller ? seller.sellerCommission : 0);
            }, 0);
            const pendingEarnings = userSales.filter(o => o.status === 'pending' || o.status === 'processing')
                .reduce((sum, order) => {
                    const seller = order.sellers.find(s => s.sellerId === currentUser.id);
                    return sum + (seller ? seller.sellerAmount : 0);
                }, 0);
            
            const content = document.getElementById('userCabinetContent');
            content.innerHTML = `
                <div class="user-cabinet-header">
                    <div class="user-avatar">${currentUser.name.charAt(0).toUpperCase()}</div>
                    <div class="user-info-main">
                        <h3>${currentUser.name}</h3>
                        <p class="user-email">${currentUser.email}</p>
                        <p class="user-since">На Re - Minko с ${new Date(currentUser.createdAt || Date.now()).toLocaleDateString('ru-RU')}</p>
                    </div>
                </div>
                
                <div class="cabinet-stats-grid">
                    <div class="stat-card stat-orders">
                        <div class="stat-icon">📦</div>
                        <div class="stat-content">
                            <h4>${userOrders.length}</h4>
                            <p>Мои заказы</p>
                            <span class="stat-amount">${totalSpent.toLocaleString()} ₽</span>
                        </div>
                    </div>
                    <div class="stat-card stat-products">
                        <div class="stat-icon">🛍️</div>
                        <div class="stat-content">
                            <h4>${userProducts.length}</h4>
                            <p>Мои товары</p>
                            <button class="stat-btn" onclick="showMyProducts()">Управлять</button>
                        </div>
                    </div>
                    <div class="stat-card stat-sales">
                        <div class="stat-icon">💰</div>
                        <div class="stat-content">
                            <h4>${userSales.length}</h4>
                            <p>Продажи</p>
                            <span class="stat-amount">${totalEarned.toLocaleString()} ₽</span>
                        </div>
                    </div>
                    <div class="stat-card stat-wishlist">
                        <div class="stat-icon">❤️</div>
                        <div class="stat-content">
                            <h4>${wishlist.length}</h4>
                            <p>Избранное</p>
                            <button class="stat-btn" onclick="toggleWishlist(); closeUserCabinet();">Посмотреть</button>
                        </div>
                    </div>
                </div>
                
                ${(function() {
                    // Показываем уведомления о новых чатах для продавца
                    const sellerNotifications = JSON.parse(localStorage.getItem('sellerNotifications')) || [];
                    const unreadChats = sellerNotifications.filter(function(n) {
                        return n.sellerId === currentUser.id && n.type === 'new_chat' && !n.read;
                    });
                    
                    if (unreadChats.length > 0) {
                        const notificationsHtml = unreadChats.map(function(notif) {
                            return '<div class="notification-item" style="padding: 1rem; margin-bottom: 0.5rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;"><div style="display: flex; justify-content: space-between; align-items: start;"><div><p style="font-weight: bold; margin-bottom: 0.25rem;">Новый чат от ' + notif.buyerName + '</p><p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Товар: ' + notif.productName + '</p><button onclick="openChatFromNotification(' + notif.chatId + ')" class="stat-btn" style="background: #4CAF50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Открыть чат</button></div></div></div>';
                        }).join('');
                        return '<div class="cabinet-section"><h4 class="cabinet-section-title">💬 Новые чаты (' + unreadChats.length + ')</h4><div class="notifications-list">' + notificationsHtml + '</div></div>';
                    }
                    return '';
                })()}
                
                <div class="cabinet-section">
                    <h4 class="cabinet-section-title">💰 Финансы</h4>
                    <div class="finance-summary">
                        <div class="finance-item">
                            <span class="finance-label">Заработано:</span>
                            <span class="finance-value positive">${totalEarned.toLocaleString()} ₽</span>
                        </div>
                        <div class="finance-item">
                            <span class="finance-label">Комиссия сайту:</span>
                            <span class="finance-value negative">-${totalCommission.toLocaleString()} ₽</span>
                        </div>
                        <div class="finance-item">
                            <span class="finance-label">Ожидает выплаты:</span>
                            <span class="finance-value pending">${pendingEarnings.toLocaleString()} ₽</span>
                        </div>
                        <div class="finance-item total">
                            <span class="finance-label">Чистый доход:</span>
                            <span class="finance-value total">${(totalEarned - totalCommission).toLocaleString()} ₽</span>
                        </div>
                    </div>
                </div>
                
                <div class="cabinet-section">
                    <h4 class="cabinet-section-title">📋 Мои заказы (покупателя)</h4>
                    <div class="orders-list">
                        ${userOrders.slice(0, 5).map(order => `
                            <div class="order-item">
                                <div class="order-info">
                                    <span class="order-id">Заказ #${order.id.toString().slice(-6)}</span>
                                    <span class="order-date">${new Date(order.createdAt).toLocaleDateString('ru-RU')}</span>
                                </div>
                                <div class="order-details">
                                    <span class="order-status status-${order.status}">${getOrderStatusText(order.status)}</span>
                                    <span class="order-total">${order.total.toLocaleString()} ₽</span>
                                </div>
                                ${order.trackingNumber ? `<div style="margin-top: 0.5rem; font-size: 12px; color: #666;">Отслеживание: ${order.trackingNumber}</div>` : ''}
                            </div>
                        `).join('') || '<p class="empty-state">Нет заказов</p>'}
                    </div>
                    ${userOrders.length > 5 ? '<button class="view-all-btn" onclick="viewAllOrders()">Посмотреть все заказы</button>' : ''}
                </div>
                
                ${userSales.length > 0 ? `
                <div class="cabinet-section">
                    <h4 class="cabinet-section-title">📦 Мои продажи</h4>
                    <div class="orders-list">
                        ${userSales.slice(0, 5).map(order => {
                            const seller = order.sellers.find(s => s.sellerId === currentUser.id);
                            return `
                            <div class="order-item">
                                <div class="order-info">
                                    <span class="order-id">Заказ #${order.id.toString().slice(-6)}</span>
                                    <span class="order-date">${new Date(order.createdAt).toLocaleDateString('ru-RU')}</span>
                                </div>
                                <div class="order-details">
                                    <span class="order-status status-${order.status}">${getOrderStatusText(order.status)}</span>
                                    <span class="order-total">${seller ? seller.sellerAmount.toLocaleString() : 0} ₽</span>
                                </div>
                                ${order.status === 'pending' || order.status === 'processing' ? `
                                    <div style="margin-top: 0.5rem;">
                                        <button onclick="showTrackingModal(${order.id})" class="stat-btn" style="background: #ff9900; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                            📦 Указать отслежку
                                        </button>
                                    </div>
                                ` : order.trackingNumber ? `
                                    <div style="margin-top: 0.5rem; font-size: 12px; color: #666;">
                                        Отслеживание: ${order.trackingNumber}
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="cabinet-section">
                    <h4 class="cabinet-section-title">⚙️ Настройки аккаунта</h4>
                    <div class="settings-grid">
                        <button class="settings-btn" onclick="showPaymentMethods(); closeUserCabinet();">
                            <span>💳</span>
                            <span>Способы оплаты</span>
                        </button>
                        <button class="settings-btn" onclick="showEditProfile();">
                            <span>✏️</span>
                            <span>Редактировать профиль</span>
                        </button>
                        <button class="settings-btn" onclick="showMyProducts(); closeUserCabinet();">
                            <span>🛍️</span>
                            <span>Мои товары</span>
                        </button>
                        <button class="settings-btn" onclick="showNotificationSettings();">
                            <span>🔔</span>
                            <span>Уведомления</span>
                        </button>
                    </div>
                </div>
                
                <div class="cabinet-actions">
                    <button class="logout-btn" onclick="logout()">Выйти из аккаунта</button>
                </div>
            `;
            document.getElementById('userCabinetModal').style.display = 'block';
        }
        
        function getOrderStatusText(status) {
            const statuses = {
                'pending': 'Ожидает оплаты',
                'processing': 'Обрабатывается',
                'shipped': 'Отправлен',
                'delivered': 'Доставлен',
                'cancelled': 'Отменен'
            };
            return statuses[status] || status;
        }
        
        function showMyProducts() {
            const userProducts = products.filter(p => p.sellerId === currentUser.id);
            if (userProducts.length === 0) {
                showNotification('У вас пока нет товаров', 'info');
                return;
            }
            showNotification(`У вас ${userProducts.length} товаров`, 'info');
        }
        
        function viewAllOrders() {
            showNotification('Просмотр всех заказов', 'info');
        }
        
        function showEditProfile() {
            showNotification('Редактирование профиля скоро будет доступно', 'info');
        }
        
        function showNotificationSettings() {
            showNotification('Настройки уведомлений скоро будут доступны', 'info');
        }

        // Close user cabinet
        function closeUserCabinet() {
            document.getElementById('userCabinetModal').style.display = 'none';
        }

        // Logout
        function logout() {
            currentUser = null;
            AppState.currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserInterface();
            closeUserCabinet();
            showNotification('Вы вышли из аккаунта', 'info');
        }


        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebarOpen = !sidebarOpen;
            
            if (sidebarOpen) {
                sidebar.classList.add('open');
                mainContent.classList.add('sidebar-open');
            } else {
                sidebar.classList.remove('open');
                mainContent.classList.remove('sidebar-open');
            }
        }

        // Show sell product modal
        function showSellProductModal() {
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт', 'warning');
                showLoginModal();
                return;
            }
            
            // Check if user has payment methods
            const userPaymentMethods = paymentMethods.filter(pm => pm.userId === currentUser.id);
            if (userPaymentMethods.length === 0) {
                showNotification('Необходимо добавить способ оплаты в профиле для получения средств', 'warning');
                showPaymentMethods();
                return;
            }
            
            document.getElementById('sellProductModal').style.display = 'block';
            toggleSidebar();
        }

        // Close sell product modal
        function closeSellProductModal() {
            document.getElementById('sellProductModal').style.display = 'none';
        }
        
        // Update subcategory options based on selected category
        function updateSubcategoryOptions() {
            const categorySelect = document.getElementById('productCategory');
            const subcategorySelect = document.getElementById('productSubcategory');
            const category = categorySelect.value;
            
            // Очищаем подкатегории
            subcategorySelect.innerHTML = '<option value="">Выберите подкатегорию</option>';
            
            if (!category) {
                subcategorySelect.disabled = true;
                return;
            }
            
            // Определяем подкатегории для каждой категории
            const subcategories = {
                'electronics': [
                    { value: 'phones', label: '📱 Смартфоны' },
                    { value: 'laptops', label: '💻 Ноутбуки' },
                    { value: 'tablets', label: '📱 Планшеты' },
                    { value: 'headphones', label: '🎧 Наушники' },
                    { value: 'cameras', label: '📷 Фотоаппараты' }
                ],
                'clothing': [
                    { value: 'men', label: '👔 Мужская' },
                    { value: 'women', label: '👗 Женская' },
                    { value: 'kids', label: '👶 Детская' },
                    { value: 'shoes', label: '👟 Обувь' },
                    { value: 'accessories', label: '👜 Аксессуары' }
                ],
                'home': [
                    { value: 'furniture', label: '🛋️ Мебель' },
                    { value: 'kitchen', label: '🍳 Кухня' },
                    { value: 'decor', label: '🖼️ Декор' },
                    { value: 'appliances', label: '⚡ Техника для дома' },
                    { value: 'garden', label: '🌳 Сад' }
                ],
                'sports': [
                    { value: 'fitness', label: '💪 Фитнес' },
                    { value: 'outdoor', label: '🏕️ Туризм' },
                    { value: 'water', label: '🏊 Водный спорт' },
                    { value: 'winter', label: '⛷️ Зимний спорт' }
                ],
                'beauty': [
                    { value: 'cosmetics', label: '💄 Косметика' },
                    { value: 'skincare', label: '🧴 Уход за кожей' },
                    { value: 'perfume', label: '🌸 Парфюмерия' },
                    { value: 'hair', label: '💇 Уход за волосами' }
                ],
                'books': [
                    { value: 'fiction', label: '📚 Художественная литература' },
                    { value: 'nonfiction', label: '📖 Научная литература' },
                    { value: 'children', label: '📗 Детские книги' },
                    { value: 'textbooks', label: '📕 Учебники' }
                ]
            };
            
            const categorySubcategories = subcategories[category] || [];
            categorySubcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.value;
                option.textContent = sub.label;
                subcategorySelect.appendChild(option);
            });
            
            subcategorySelect.disabled = false;
        }

        // Handle sell product with database save
        async function handleSellProduct(event) {
            event.preventDefault();
            
            showLoading();
            
            // Получаем изображения
            let productImages = [];
            if (window.productImageFiles && window.productImageFiles.length > 0) {
                const imagePromises = Array.from(window.productImageFiles).slice(0, 10).map(file => {
                    if (!file.type.startsWith('image/')) return null;
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => resolve(null);
                        reader.readAsDataURL(file);
                    });
                });
                productImages = (await Promise.all(imagePromises)).filter(img => img !== null);
            }

            // Проверяем обязательные поля
            const subcategory = document.getElementById('productSubcategory')?.value;
            if (!subcategory) {
                showNotification('Пожалуйста, выберите подкатегорию товара', 'warning');
                hideLoading();
                return;
            }
            
            const productData = {
                id: Date.now(),
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                subcategory: subcategory,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                discount: parseInt(document.getElementById('productDiscount').value) || 0,
                description: document.getElementById('productDescription').value,
                sellerId: currentUser.id,
                sellerName: currentUser.name,
                createdAt: new Date().toISOString(),
                rating: 0,
                image: productImages.length > 0 ? productImages[0] : '📦', // Первое изображение или placeholder
                images: productImages, // Все изображения
                badge: 'new'
            };

            // Calculate original price if discount exists
            if (productData.discount > 0) {
                productData.originalPrice = productData.price;
                productData.price = productData.price * (1 - productData.discount / 100);
            }

            try {
                // Save to database
                const savedProduct = await saveProductToDB(productData);
                
                // Add to local arrays
                const finalProduct = savedProduct || productData;
                products.push(finalProduct);
                userProducts.push(finalProduct);
                localStorage.setItem('userProducts', JSON.stringify(userProducts));
                localStorage.setItem('products', JSON.stringify(products));
                
                // Update display
                filteredProducts = [...products];
                displayProducts(filteredProducts);
                updateProductCounter();
                
                // Очищаем изображения
                window.productImageFiles = [];
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
                
                hideLoading();
                showNotification('Товар успешно опубликован!', 'success');
                closeSellProductModal();
                document.getElementById('sellProductForm').reset();
            } catch (error) {
                hideLoading();
                console.error('Error saving product:', error);
                showNotification('Ошибка при сохранении товара. Попробуйте позже.', 'error');
            }
        }

        // Show my products
        function showMyProducts() {
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт', 'warning');
                showLoginModal();
                return;
            }

            const myProducts = userProducts.filter(product => product.sellerId === currentUser.id);
            const content = document.getElementById('myProductsContent');
            
            if (myProducts.length === 0) {
                content.innerHTML = '<p style="text-align: center; padding: 2rem;">У вас пока нет товаров</p>';
            } else {
                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        ${myProducts.map(product => `
                            <div style="border: 1px solid #ddd; border-radius: 10px; padding: 1rem;">
                                <h4>${product.name}</h4>
                                <p><strong>Цена:</strong> $${product.price.toFixed(2)}</p>
                                <p><strong>Остаток:</strong> ${product.stock} шт.</p>
                                <p><strong>Статус:</strong> ${product.badge === 'new' ? 'Новый' : 'Активный'}</p>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button class="add-to-cart" onclick="editProduct(${product.id})" style="flex: 1;">Редактировать</button>
                                    <button class="remove-item" onclick="deleteProduct(${product.id})" style="flex: 1;">Удалить</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('myProductsModal').style.display = 'block';
            toggleSidebar();
        }

        // Close my products modal
        function closeMyProductsModal() {
            document.getElementById('myProductsModal').style.display = 'none';
        }

        // Show sales stats
        function showSalesStats() {
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт', 'warning');
                showLoginModal();
                return;
            }

            const myProducts = userProducts.filter(product => product.sellerId === currentUser.id);
            const totalProducts = myProducts.length;
            const totalValue = myProducts.reduce((sum, product) => sum + (product.price * product.stock), 0);
            
            const content = document.getElementById('salesStatsContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 10px;">
                        <h4>Всего товаров</h4>
                        <p style="font-size: 2rem; color: #667eea;">${totalProducts}</p>
                    </div>
                    <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 10px;">
                        <h4>Общая стоимость</h4>
                        <p style="font-size: 2rem; color: #667eea;">$${totalValue.toFixed(2)}</p>
                    </div>
                    <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 10px;">
                        <h4>Средняя цена</h4>
                        <p style="font-size: 2rem; color: #667eea;">$${totalProducts > 0 ? (totalValue / totalProducts).toFixed(2) : '0.00'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('salesStatsModal').style.display = 'block';
            toggleSidebar();
        }

        // Close sales stats modal
        function closeSalesStatsModal() {
            document.getElementById('salesStatsModal').style.display = 'none';
        }

        // Edit product
        function editProduct(productId) {
            const product = userProducts.find(p => p.id === productId);
            if (product) {
                // Fill form with product data
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPrice').value = product.originalPrice || product.price;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productDiscount').value = product.discount || 0;
                document.getElementById('productDescription').value = product.description;
                
                showSellProductModal();
            }
        }

        // Delete product
        function deleteProduct(productId) {
            if (confirm('Вы уверены, что хотите удалить этот товар?')) {
                userProducts = userProducts.filter(p => p.id !== productId);
                localStorage.setItem('userProducts', JSON.stringify(userProducts));
                
                // Remove from main products
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex > -1) {
                    products.splice(productIndex, 1);
                    filteredProducts = [...products];
                }
                
                showNotification('Товар удален', 'info');
                showMyProducts(); // Refresh the list
            }
        }

        // Show newsletter modal
        function showNewsletterModal() {
            showNotification('Подписка на рассылку активирована!', 'success');
        }

        // Show payment methods modal
        function showPaymentMethods() {
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт', 'warning');
                showLoginModal();
                return;
            }
            
            loadPaymentMethods();
            document.getElementById('paymentMethodsModal').style.display = 'block';
            closeUserCabinet();
        }

        // Close payment methods modal
        function closePaymentMethodsModal() {
            document.getElementById('paymentMethodsModal').style.display = 'none';
        }

        // Load payment methods
        function loadPaymentMethods() {
            const userPaymentMethods = paymentMethods.filter(pm => pm.userId === currentUser.id);
            const list = document.getElementById('paymentMethodsList');
            
            if (userPaymentMethods.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">У вас нет добавленных способов оплаты</p>';
            } else {
                list.innerHTML = userPaymentMethods.map(pm => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 1rem;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">${getPaymentIcon(pm.type)}</span>
                                <div>
                                    <h6 style="margin: 0;">${pm.type.toUpperCase()}</h6>
                                    <p style="margin: 0; color: #666; font-size: 0.9rem;">${pm.address}</p>
                                    ${pm.cardHolder ? `<p style="margin: 0; color: #666; font-size: 0.8rem;">${pm.cardHolder}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        <button class="remove-item" onclick="removePaymentMethod(${pm.id})">Удалить</button>
                    </div>
                `).join('');
            }
        }

        // Get payment icon
        function getPaymentIcon(type) {
            const icons = {
                'mastercard': '💳',
                'visa': '💳',
                'bitcoin': '₿',
                'ethereum': 'Ξ',
                'usdt': '₮'
            };
            return icons[type] || '💳';
        }

        // Add payment method
        function addPaymentMethod(event) {
            event.preventDefault();
            
            const type = document.getElementById('paymentType').value;
            const address = document.getElementById('paymentAddress').value;
            const cardHolder = document.getElementById('cardHolder').value;
            
            const paymentMethod = {
                id: Date.now(),
                userId: currentUser.id,
                type: type,
                address: address,
                cardHolder: cardHolder,
                createdAt: new Date().toISOString()
            };
            
            paymentMethods.push(paymentMethod);
            localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
            
            showNotification('Способ оплаты добавлен!', 'success');
            loadPaymentMethods();
            
            // Clear form
            document.getElementById('paymentType').value = '';
            document.getElementById('paymentAddress').value = '';
            document.getElementById('cardHolder').value = '';
        }

        // Remove payment method
        function removePaymentMethod(paymentMethodId) {
            if (confirm('Вы уверены, что хотите удалить этот способ оплаты?')) {
                paymentMethods = paymentMethods.filter(pm => pm.id !== paymentMethodId);
                localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
                showNotification('Способ оплаты удален', 'info');
                loadPaymentMethods();
            }
        }

        // Subscribe newsletter
        function subscribeNewsletter(event) {
            event.preventDefault();
            showNotification('Спасибо за подписку!', 'success');
        }

        // Scroll to products
        function scrollToProducts() {
            const productsSection = document.getElementById('productsSection');
            if (productsSection && productsSection.style.display !== 'none') {
                productsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }


        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show loading
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Update breadcrumbs
        function updateBreadcrumbs(category, subcategory = null, searchTerm = '') {
            const breadcrumbCategory = document.getElementById('breadcrumbCategory');
            const categoryNames = {
                'electronics': 'Электроника',
                'clothing': 'Одежда',
                'home': 'Дом и кухня',
                'sports': 'Спорт',
                'beauty': 'Красота',
                'books': 'Книги'
            };
            const subcategoryNames = {
                'phones': 'Смартфоны',
                'laptops': 'Ноутбуки',
                'tablets': 'Планшеты',
                'headphones': 'Наушники',
                'cameras': 'Фотоаппараты',
                'men': 'Мужская',
                'women': 'Женская',
                'kids': 'Детская',
                'shoes': 'Обувь',
                'accessories': 'Аксессуары',
                'furniture': 'Мебель',
                'kitchen': 'Кухня',
                'decor': 'Декор',
                'appliances': 'Техника для дома',
                'garden': 'Сад',
                'fitness': 'Фитнес',
                'outdoor': 'Туризм',
                'water': 'Водный спорт',
                'winter': 'Зимний спорт',
                'cosmetics': 'Косметика',
                'skincare': 'Уход за кожей',
                'perfume': 'Парфюмерия',
                'hair': 'Уход за волосами',
                'fiction': 'Художественная',
                'business': 'Бизнес',
                'tech': 'Техническая',
                'children': 'Детская'
            };
            
            if (!breadcrumbCategory) return;
            
            if (category === 'search') {
                breadcrumbCategory.textContent = `Поиск: "${searchTerm}"`;
            } else if (subcategory) {
                breadcrumbCategory.textContent = `${categoryNames[category] || category} > ${subcategoryNames[subcategory] || subcategory}`;
            } else {
                breadcrumbCategory.textContent = categoryNames[category] || category || 'Все товары';
            }
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        // Add smooth scrolling to all links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Ctrl+K to focus search
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        // Add loading states to buttons
        function addLoadingState(button, text = 'Загрузка...') {
            const originalText = button.textContent;
            button.textContent = text;
            button.disabled = true;
            button.style.opacity = '0.7';
            
            return () => {
                button.textContent = originalText;
                button.disabled = false;
                button.style.opacity = '1';
            };
        }

        // Improved add to cart with loading
        function addToCartWithLoading(productId) {
            const button = event.target;
            const resetButton = addLoadingState(button, 'Добавляем...');
            
            setTimeout(() => {
                addToCart(productId);
                resetButton();
            }, 500);
        }

        // Process payment
        function processPayment(order) {
            // Simulate payment processing
            showLoading();
            
            setTimeout(() => {
                // Get buyer's payment method
                const buyerPaymentMethods = paymentMethods.filter(pm => pm.userId === order.buyerId);
                const buyerPaymentMethod = buyerPaymentMethods[0];
                
                if (!buyerPaymentMethod) {
                    showNotification('Ошибка: способ оплаты не найден', 'error');
                    hideLoading();
                    return;
                }
                
                // Process payment for each seller
                order.sellers.forEach(seller => {
                    // Find seller's payment method
                    const sellerPaymentMethods = paymentMethods.filter(pm => pm.userId === seller.sellerId);
                    const sellerPaymentMethod = sellerPaymentMethods[0];
                    
                    if (sellerPaymentMethod) {
                        // Simulate money transfer
                        console.log(`Transferring $${seller.sellerAmount.toFixed(2)} from ${buyerPaymentMethod.address} to ${sellerPaymentMethod.address}`);
                        
                        // Update seller's balance (in real app, this would be done via payment processor)
                        updateSellerBalance(seller.sellerId, seller.sellerAmount);
                    }
                });
                
                // Update order status
                order.status = 'completed';
                order.completedAt = new Date().toISOString();
                localStorage.setItem('orders', JSON.stringify(orders));
                
                hideLoading();
                showNotification('Платеж успешно обработан! Средства переведены продавцам.', 'success');
            }, 2000);
        }

        // Update seller balance (simulation)
        function updateSellerBalance(sellerId, amount) {
            // In a real app, this would update the seller's balance in the database
            console.log(`Seller ${sellerId} received $${amount.toFixed(2)}`);
        }

        // Chat functions
        function openChat(sellerId, productId) {
            if (!currentUser) {
                showNotification('Необходимо войти в аккаунт', 'warning');
                showLoginModal();
                return;
            }

            const seller = users.find(u => u.id === sellerId);
            if (!seller) {
                showNotification('Продавец не найден', 'error');
                return;
            }

            // Find or create chat
            let chat = chats.find(c => 
                (c.buyerId === currentUser.id && c.sellerId === sellerId) ||
                (c.buyerId === sellerId && c.sellerId === currentUser.id)
            );

            if (!chat) {
                const product = products.find(p => p.id === productId);
                chat = {
                    id: Date.now(),
                    buyerId: currentUser.id,
                    sellerId: sellerId,
                    productId: productId,
                    productName: product ? product.name : 'Товар',
                    messages: [],
                    status: 'pending', // pending - ожидает принятия продавцом, active - активен
                    escrowAmount: 0,
                    escrowStatus: 'none', // none, pending, paid, delivered, completed
                    createdAt: new Date().toISOString(),
                    sellerNotified: false
                };
                chats.push(chat);
                localStorage.setItem('chats', JSON.stringify(chats));
                
                // Уведомляем продавца о новом чате
                notifySellerAboutNewChat(sellerId, chat.id, currentUser.name, product ? product.name : 'Товар');
            }

            currentChat = chat;
            document.getElementById('chatTitle').textContent = `Чат с ${seller.name}`;
            loadChatMessages();
            document.getElementById('chatModal').style.display = 'block';
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
            currentChat = null;
        }
        
        // Уведомить продавца о новом чате
        function notifySellerAboutNewChat(sellerId, chatId, buyerName, productName) {
            // Сохраняем уведомление в localStorage
            let notifications = JSON.parse(localStorage.getItem('sellerNotifications')) || [];
            notifications.push({
                id: Date.now(),
                sellerId: sellerId,
                chatId: chatId,
                buyerName: buyerName,
                productName: productName,
                type: 'new_chat',
                read: false,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('sellerNotifications', JSON.stringify(notifications));
            
            // Показываем уведомление если продавец онлайн
            if (currentUser && currentUser.id === sellerId) {
                showNotification(`💬 Новый чат от ${buyerName} по товару "${productName}"`, 'info');
            }
        }
        
        // Открыть чат из уведомления
        function openChatFromNotification(chatId) {
            const chat = chats.find(function(c) { return c.id === chatId; });
            if (chat) {
                currentChat = chat;
                openChat(chat.sellerId, chat.productId);
                closeUserCabinet();
            }
        }
        
        // Проверить уведомления продавца
        function checkSellerNotifications() {
            if (!currentUser) return;
            
            const notifications = JSON.parse(localStorage.getItem('sellerNotifications')) || [];
            const unreadChats = notifications.filter(n => 
                n.sellerId === currentUser.id && 
                n.type === 'new_chat' && 
                !n.read
            );
            
            if (unreadChats.length > 0) {
                // Показываем уведомление в интерфейсе
                const notificationCount = document.getElementById('notificationCount');
                if (notificationCount) {
                    notificationCount.textContent = unreadChats.length;
                    notificationCount.style.display = 'block';
                }
            }
        }
        
        // Принять чат продавцом
        function acceptChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) {
                showNotification('Чат не найден', 'error');
                return;
            }
            
            if (chat.sellerId !== currentUser.id) {
                showNotification('Только продавец может принять чат', 'warning');
                return;
            }
            
            chat.status = 'active';
            chat.acceptedAt = new Date().toISOString();
            
            // Добавляем системное сообщение
            chat.messages.push({
                id: Date.now(),
                senderId: 'system',
                text: '✅ Продавец принял чат. Теперь вы можете общаться.',
                timestamp: new Date().toISOString()
            });
            
            chats = chats.map(c => c.id === chatId ? chat : c);
            localStorage.setItem('chats', JSON.stringify(chats));
            
            // Удаляем уведомление
            let notifications = JSON.parse(localStorage.getItem('sellerNotifications')) || [];
            notifications = notifications.filter(n => !(n.chatId === chatId && n.type === 'new_chat'));
            localStorage.setItem('sellerNotifications', JSON.stringify(notifications));
            
            currentChat = chat;
            loadChatMessages();
            showNotification('Чат принят! Теперь вы можете общаться с покупателем.', 'success');
        }

        function loadChatMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            const chatActions = document.getElementById('chatActions');
            
            messagesContainer.innerHTML = '';
            
            // Показываем статус чата
            if (currentChat.status === 'pending' && currentChat.sellerId === currentUser.id) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #fff3cd; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="font-weight: bold; margin-bottom: 0.5rem;">💬 Новый чат от покупателя</p>
                        <p style="color: #666; margin-bottom: 1rem;">Товар: ${currentChat.productName || 'Не указан'}</p>
                        <button onclick="acceptChat(${currentChat.id})" class="checkout-btn" style="background: #4CAF50;">
                            ✅ Принять чат
                        </button>
                    </div>
                `;
            } else if (currentChat.status === 'pending' && currentChat.buyerId === currentUser.id) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #d1ecf1; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="font-weight: bold; margin-bottom: 0.5rem;">⏳ Ожидание ответа продавца</p>
                        <p style="color: #666;">Продавец еще не принял ваш чат. Вы сможете написать сообщение после того, как продавец примет чат.</p>
                    </div>
                `;
            } else if (currentChat.messages.length === 0) {
                messagesContainer.innerHTML = '<p style="text-align: center; color: #666;">Начните общение</p>';
            } else {
                currentChat.messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        margin-bottom: 1rem;
                        padding: 10px;
                        border-radius: 10px;
                        max-width: 70%;
                        ${message.senderId === currentUser.id ? 
                            'background: #667eea; color: white; margin-left: auto;' : 
                            'background: white; border: 1px solid #ddd;'
                        }
                    `;
                    messageDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${message.senderId === currentUser.id ? 'Вы' : 'Продавец'}
                        </div>
                        <div>${message.text}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">
                            ${new Date(message.timestamp).toLocaleString()}
                        </div>
                    `;
                    messagesContainer.appendChild(messageDiv);
                });
            }

            // Show chat actions based on escrow status (только если чат активен)
            if (currentChat.status === 'active') {
                if (currentChat.escrowStatus === 'none' && currentChat.buyerId === currentUser.id) {
                    chatActions.style.display = 'block';
                    chatActions.innerHTML = `
                        <button onclick="initiateEscrowPayment()" class="checkout-btn" style="background: #4CAF50;">
                            💳 Оплатить через эскроу
                        </button>
                    `;
                } else if (currentChat.escrowStatus === 'paid' && currentChat.sellerId === currentUser.id) {
                chatActions.style.display = 'block';
                chatActions.innerHTML = `
                    <button onclick="confirmDelivery()" class="checkout-btn" style="background: #2196F3;">
                        ✅ Подтвердить отправку товара
                    </button>
                `;
            } else if (currentChat.escrowStatus === 'delivered' && currentChat.buyerId === currentUser.id) {
                chatActions.style.display = 'block';
                chatActions.innerHTML = `
                    <button onclick="confirmReceipt()" class="checkout-btn" style="background: #4CAF50;">
                        ✅ Подтвердить получение товара
                    </button>
                `;
            } else {
                chatActions.style.display = 'none';
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            // Проверяем, что чат активен
            if (currentChat.status === 'pending') {
                if (currentChat.sellerId === currentUser.id) {
                    showNotification('Сначала примите чат', 'warning');
                } else {
                    showNotification('Ожидайте принятия чата продавцом', 'info');
                }
                return;
            }

            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                text: text,
                timestamp: new Date().toISOString()
            };

            currentChat.messages.push(message);
            chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
            localStorage.setItem('chats', JSON.stringify(chats));

            input.value = '';
            loadChatMessages();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function initiateEscrowPayment() {
            const product = products.find(p => p.id === currentChat.productId);
            if (!product) {
                showNotification('Товар не найден', 'error');
                return;
            }

            const total = product.price + (product.price * siteCommission);
            currentChat.escrowAmount = total;
            
            document.getElementById('escrowAmount').value = total.toFixed(2);
            
            // Load user payment methods
            const userPaymentMethods = paymentMethods.filter(pm => pm.userId === currentUser.id && pm.type !== 'escrow');
            const select = document.getElementById('escrowPaymentMethod');
            select.innerHTML = '<option value="">Выберите способ оплаты</option>';
            
            userPaymentMethods.forEach(pm => {
                const option = document.createElement('option');
                option.value = pm.id;
                option.textContent = `${pm.type.toUpperCase()} - ${pm.address}`;
                select.appendChild(option);
            });

            document.getElementById('escrowPaymentModal').style.display = 'block';
            closeChatModal();
        }

        function closeEscrowPaymentModal() {
            document.getElementById('escrowPaymentModal').style.display = 'none';
        }

        function processEscrowPayment() {
            const paymentMethodId = document.getElementById('escrowPaymentMethod').value;
            if (!paymentMethodId) {
                showNotification('Выберите способ оплаты', 'warning');
                return;
            }

            const paymentMethod = paymentMethods.find(pm => pm.id == paymentMethodId);
            if (!paymentMethod) {
                showNotification('Способ оплаты не найден', 'error');
                return;
            }

            // Simulate payment to escrow
            showLoading();
            setTimeout(() => {
                // Add money to escrow balance
                escrowBalance += currentChat.escrowAmount;
                localStorage.setItem('escrowBalance', JSON.stringify(escrowBalance));

                // Update chat status
                currentChat.escrowStatus = 'paid';
                chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
                localStorage.setItem('chats', JSON.stringify(chats));

                // Add system message
                const systemMessage = {
                    id: Date.now(),
                    senderId: 'system',
                    text: `💰 Платеж $${currentChat.escrowAmount.toFixed(2)} заморожен на эскроу счете. Ожидайте подтверждения отправки от продавца.`,
                    timestamp: new Date().toISOString()
                };
                currentChat.messages.push(systemMessage);
                chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
                localStorage.setItem('chats', JSON.stringify(chats));

                hideLoading();
                closeEscrowPaymentModal();
                openChat(currentChat.sellerId, currentChat.productId);
                showNotification('Платеж успешно заморожен на эскроу счете!', 'success');
            }, 2000);
        }

        function confirmDelivery() {
            if (!currentChat) return;

            currentChat.escrowStatus = 'delivered';
            chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
            localStorage.setItem('chats', JSON.stringify(chats));

            // Add system message
            const systemMessage = {
                id: Date.now(),
                senderId: 'system',
                text: '📦 Продавец подтвердил отправку товара. После получения подтвердите получение для разблокировки средств.',
                timestamp: new Date().toISOString()
            };
            currentChat.messages.push(systemMessage);
            chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
            localStorage.setItem('chats', JSON.stringify(chats));

            loadChatMessages();
            showNotification('Отправка подтверждена!', 'success');
        }

        function confirmReceipt() {
            if (!currentChat) return;

            // Release escrow funds to seller
            const sellerAmount = currentChat.escrowAmount * (1 - siteCommission);
            const commission = currentChat.escrowAmount * siteCommission;
            
            escrowBalance -= currentChat.escrowAmount;
            localStorage.setItem('escrowBalance', JSON.stringify(escrowBalance));

            // Update seller balance
            updateSellerBalance(currentChat.sellerId, sellerAmount);

            currentChat.escrowStatus = 'completed';
            chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
            localStorage.setItem('chats', JSON.stringify(chats));

            // Add system message
            const systemMessage = {
                id: Date.now(),
                senderId: 'system',
                text: `✅ Получение подтверждено! Продавец получил $${sellerAmount.toFixed(2)} (комиссия сайта: $${commission.toFixed(2)})`,
                timestamp: new Date().toISOString()
            };
            currentChat.messages.push(systemMessage);
            chats = chats.map(c => c.id === currentChat.id ? currentChat : c);
            localStorage.setItem('chats', JSON.stringify(chats));

            loadChatMessages();
            showNotification('Сделка завершена! Средства переведены продавцу.', 'success');
        }

        // Show category subcategories
        function showSubcategories(category, element) {
            const submenu = element.querySelector('.subcategories-menu');
            if (submenu) {
                submenu.style.display = 'block';
            }
        }
        
        function hideSubcategories(element) {
            const submenu = element.querySelector('.subcategories-menu');
            if (submenu) {
                setTimeout(() => {
                    if (!element.matches(':hover') && !submenu.matches(':hover')) {
                        submenu.style.display = 'none';
                    }
                }, 200);
            }
        }

        // Show blog submenu
        function showBlogSubmenu(event) {
            const submenu = document.getElementById('blogSubmenu');
            if (submenu) {
                submenu.style.display = 'block';
            }
        }

        // Hide blog submenu
        function hideBlogSubmenu(event) {
            const submenu = document.getElementById('blogSubmenu');
            if (submenu) {
                setTimeout(() => {
                    if (!event.relatedTarget || !event.relatedTarget.closest('#blogSubmenu')) {
                        submenu.style.display = 'none';
                    }
                }, 200);
            }
        }

        // Show tracking modal for seller
        function showTrackingModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('Заказ не найден', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>📦 Указать номер отслеживания</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p style="margin-bottom: 1rem; color: #666;">Заказ #${order.id.toString().slice(-6)}</p>
                        <div class="form-group">
                            <label for="trackingNumberInput">Номер отслеживания</label>
                            <input type="text" id="trackingNumberInput" class="form-control" placeholder="Введите номер отслеживания" value="${order.trackingNumber || ''}">
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="trackingCarrier">Служба доставки</label>
                            <select id="trackingCarrier" class="form-control">
                                <option value="">Выберите службу</option>
                                <option value="Почта России">Почта России</option>
                                <option value="СДЭК">СДЭК</option>
                                <option value="Boxberry">Boxberry</option>
                                <option value="DHL">DHL</option>
                                <option value="Другая">Другая</option>
                            </select>
                        </div>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button onclick="saveTrackingNumber(${orderId})" class="btn-primary" style="flex: 1;">Сохранить</button>
                            <button onclick="this.closest('.modal').remove()" class="btn-secondary" style="flex: 1;">Отмена</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Save tracking number
        function saveTrackingNumber(orderId) {
            const trackingNumber = document.getElementById('trackingNumberInput').value.trim();
            const carrier = document.getElementById('trackingCarrier').value;

            if (!trackingNumber) {
                showNotification('Введите номер отслеживания', 'warning');
                return;
            }

            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('Заказ не найден', 'error');
                return;
            }

            // Обновляем заказ
            order.trackingNumber = trackingNumber;
            if (order.delivery) {
                order.delivery.carrier = carrier || order.delivery.carrier || 'Не указана';
                order.delivery.trackingNumber = trackingNumber;
                order.delivery.status = 'shipped';
                order.delivery.trackingHistory.push({
                    status: 'shipped',
                    message: `Товар отправлен. Номер отслеживания: ${trackingNumber}`,
                    timestamp: new Date().toISOString(),
                    location: 'Отправлено продавцом'
                });
            } else {
                order.delivery = {
                    status: 'shipped',
                    trackingNumber: trackingNumber,
                    carrier: carrier || 'Не указана',
                    estimatedDelivery: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    trackingHistory: [{
                        status: 'shipped',
                        message: `Товар отправлен. Номер отслеживания: ${trackingNumber}`,
                        timestamp: new Date().toISOString(),
                        location: 'Отправлено продавцом'
                    }]
                };
            }

            order.status = 'shipped';
            orders = orders.map(o => o.id === orderId ? order : o);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Сохраняем в базу данных
            if (supabase) {
                saveOrderToDB(order).catch(err => console.error('Error saving tracking:', err));
            }

            // Уведомляем покупателя
            showNotification('Номер отслеживания сохранен! Покупатель получит уведомление.', 'success');
            
            // Закрываем модальное окно
            document.querySelector('.modal').remove();
            
            // Обновляем кабинет
            if (document.getElementById('userCabinetModal').style.display === 'block') {
                showUserCabinet();
            }
        }
        
        function showCategorySubcategories(category, subcategory = null) {
            showLoading();
            
            setTimeout(() => {
                try {
                    if (subcategory) {
                        // Фильтр по категории И подкатегории
                        filteredProducts = products.filter(product => 
                            product.category === category && product.subcategory === subcategory
                        );
                    } else {
                        // Фильтр только по категории
                        filteredProducts = products.filter(product => product.category === category);
                    }
                    
                    displayProducts(filteredProducts);
                    updateProductCounter();
                    updateBreadcrumbs(category, subcategory);
                    
                    // Прокрутка к товарам только если секция видна
                    const productsSection = document.getElementById('productsSection');
                    if (productsSection && productsSection.style.display !== 'none') {
                        productsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    
                    // Закрываем все подменю
                    document.querySelectorAll('.subcategories-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                    
                    hideLoading();
                    
                    if (filteredProducts.length === 0) {
                        showNotification('Товары в этой категории не найдены', 'info');
                    }
                } catch (error) {
                    console.error('Category filter error:', error);
                    hideLoading();
                    showNotification('Ошибка при фильтрации товаров', 'error');
                }
            }, 200);
        }

        // Preview product images
        function previewProductImages(event) {
            const files = event.target.files;
            const container = document.getElementById('imagePreviewContainer');
            const grid = document.getElementById('imagePreviewGrid');
            
            if (!files || files.length === 0) {
                if (container) container.style.display = 'none';
                window.productImageFiles = [];
                return;
            }

            if (!grid || !container) return;

            grid.innerHTML = '';
            container.style.display = 'block';

            // Сохраняем файлы для последующего использования
            window.productImageFiles = Array.from(files).slice(0, 10).filter(f => f.type.startsWith('image/'));

            window.productImageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.style.cssText = 'position: relative; width: 100%; padding-top: 100%; border-radius: 8px; overflow: hidden; border: 2px solid #e9ecef;';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="showImagePreview('${e.target.result}')">
                        <button onclick="removeImagePreview(${index}, event)" style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">×</button>
                    `;
                    grid.appendChild(previewItem);
                };
                reader.onerror = function() {
                    showNotification(`Ошибка загрузки изображения "${file.name}"`, 'error');
                };
                reader.readAsDataURL(file);
            });
        }

        // Show full image preview
        function showImagePreview(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.innerHTML = `
                <div style="max-width: 90vw; max-height: 90vh; position: relative;">
                    <img src="${imageSrc}" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
                    <button onclick="this.closest('.modal').remove()" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 24px;">×</button>
                </div>
            `;
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // Remove image preview
        function removeImagePreview(index, event) {
            event.stopPropagation();
            if (window.productImageFiles && window.productImageFiles[index]) {
                window.productImageFiles.splice(index, 1);
                // Обновляем input
                const input = document.getElementById('productImages');
                if (input) {
                    const dt = new DataTransfer();
                    window.productImageFiles.forEach(file => dt.items.add(file));
                    input.files = dt.files;
                }
                // Перерисовываем превью
                const fakeEvent = { target: { files: window.productImageFiles } };
                previewProductImages(fakeEvent);
            }
        }

        // Show account menu
        function showAccountMenu(event) {
            event.stopPropagation();
            if (currentUser) {
                showUserCabinet();
            } else {
                showLoginModal();
            }
        }

        // Initialize recommended products carousel
        function initRecommendedCarousel() {
            const carousel = document.getElementById('recommendedCarousel');
            if (!carousel) return;

            const recommendedProducts = products.slice(0, 10);
            
            if (recommendedProducts.length === 0) {
                carousel.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Рекомендуемые товары появятся здесь</p>';
                return;
            }

            recommendedProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.style.minWidth = '300px';
                
                const imageUrl = getProductImageUrl(product.category, product.name);
                productCard.innerHTML = `
                    <div class="product-image" style="background-image: url('${imageUrl}');">
                        <img src="${imageUrl}" alt="${product.name}" style="display: none;" onload="this.style.display='block'; this.parentElement.style.background='none';" onerror="this.parentElement.innerHTML='${product.image}';">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <div class="product-price">${product.price.toLocaleString()} ₽</div>
                        <button class="add-to-cart" onclick="addToCart(${product.id})">В корзину</button>
                    </div>
                `;
                carousel.appendChild(productCard);
            });
        }

        // ========== NEW ADVANCED FEATURES ==========
        
        // Compare Products State
        let compareList = JSON.parse(localStorage.getItem('compareList')) || [];
        let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed')) || [];
        
        // Scroll Progress Bar
        window.addEventListener('scroll', function() {
            const scrollProgress = document.getElementById('scrollProgress');
            const scrollTop = window.pageYOffset;
            const docHeight = document.body.scrollHeight - window.innerHeight;
            const scrollPercent = (scrollTop / docHeight) * 100;
            if (scrollProgress) scrollProgress.style.width = scrollPercent + '%';
            
            // Back to top button
            const backToTop = document.getElementById('backToTop');
            if (backToTop) {
                if (scrollTop > 300) {
                    backToTop.classList.add('show');
                } else {
                    backToTop.classList.remove('show');
                }
            }
        });
        
        // Scroll to top
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Toggle Wishlist
        function toggleWishlist(productId, event) {
            if (event) event.stopPropagation();
            const product = products.find(p => p.id === productId);
            const index = wishlist.findIndex(w => w.id === productId);
            
            if (index > -1) {
                wishlist.splice(index, 1);
                showNotification('Удалено из избранного', 'info');
            } else {
                wishlist.push(product);
                showNotification('Добавлено в избранное', 'success');
            }
            
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateWishlistDisplay();
            displayProducts(filteredProducts);
        }
        
        // Toggle Compare
        function toggleCompare(productId, event) {
            if (event) event.stopPropagation();
            const product = products.find(p => p.id === productId);
            const index = compareList.findIndex(c => c.id === productId);
            
            if (index > -1) {
                compareList.splice(index, 1);
                showNotification('Удалено из сравнения', 'info');
            } else {
                if (compareList.length >= 3) {
                    showNotification('Можно сравнить максимум 3 товара', 'warning');
                    return;
                }
                compareList.push(product);
                showNotification('Добавлено в сравнение', 'success');
            }
            
            localStorage.setItem('compareList', JSON.stringify(compareList));
            updateCompareBar();
            displayProducts(filteredProducts);
        }
        
        // Update Compare Bar
        function updateCompareBar() {
            const compareBar = document.getElementById('compareBar');
            const compareListEl = document.getElementById('compareList');
            
            if (!compareBar || !compareListEl) return;
            
            if (compareList.length === 0) {
                compareBar.classList.remove('show');
                return;
            }
            
            compareBar.classList.add('show');
            compareListEl.innerHTML = compareList.map(product => `
                <div class="compare-item">
                    <img src="${getProductImageUrl(product.category, product.name)}" alt="${product.name}" onerror="this.style.display='none'">
                    <span style="font-size: 12px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${product.name}</span>
                    <button class="remove" onclick="toggleCompare(${product.id})">×</button>
                </div>
            `).join('');
        }
        
        // Show Compare Modal
        function showCompareModal() {
            if (compareList.length < 2) {
                showNotification('Добавьте минимум 2 товара для сравнения', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1200px;">
                    <div class="modal-header">
                        <h3>Сравнение товаров</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 1rem; text-align: left; border: 1px solid #e0e0e0;">Характеристика</th>
                                    ${compareList.map(p => `<th style="padding: 1rem; text-align: center; border: 1px solid #e0e0e0;">${p.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 1rem; border: 1px solid #e0e0e0; font-weight: 500;">Цена</td>
                                    ${compareList.map(p => `<td style="padding: 1rem; text-align: center; border: 1px solid #e0e0e0;">${p.price.toLocaleString()} ₽</td>`).join('')}
                                </tr>
                                <tr>
                                    <td style="padding: 1rem; border: 1px solid #e0e0e0; font-weight: 500;">Рейтинг</td>
                                    ${compareList.map(p => `<td style="padding: 1rem; text-align: center; border: 1px solid #e0e0e0;">${(p.rating || 4)}/5 ⭐</td>`).join('')}
                                </tr>
                                <tr>
                                    <td style="padding: 1rem; border: 1px solid #e0e0e0; font-weight: 500;">Категория</td>
                                    ${compareList.map(p => `<td style="padding: 1rem; text-align: center; border: 1px solid #e0e0e0;">${p.category}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td style="padding: 1rem; border: 1px solid #e0e0e0; font-weight: 500;">Описание</td>
                                    ${compareList.map(p => `<td style="padding: 1rem; text-align: center; border: 1px solid #e0e0e0; max-width: 200px;">${p.description.substring(0, 100)}...</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        ${compareList.map(p => `<button class="add-to-cart" onclick="addToCart(${p.id}); this.closest('.modal').remove();">В корзину</button>`).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Quick View
        function quickView(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            addToRecentlyViewed(product);
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content quick-view-modal">
                    <div class="modal-header">
                        <h3>${product.name}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="quick-view-content">
                        <div>
                            <img src="${getProductImageUrl(product.category, product.name)}" alt="${product.name}" style="width: 100%; border-radius: 4px;">
                        </div>
                        <div>
                            <div class="product-rating-display">
                                <span class="stars-filled">${'★'.repeat(product.rating || 4)}${'☆'.repeat(5-(product.rating || 4))}</span>
                                <span class="rating-number">(${Math.floor(Math.random() * 500) + 10} отзывов)</span>
                            </div>
                            <div class="product-price" style="font-size: 1.8rem; margin: 1rem 0;">
                                ${product.price.toLocaleString()} ₽
                            </div>
                            <p style="margin: 1rem 0; line-height: 1.6;">${product.description}</p>
                            <div class="product-buttons" style="margin-top: 1.5rem;">
                                <button class="add-to-cart" onclick="addToCart(${product.id})">В корзину</button>
                                <button class="buy-now" onclick="buyNow(${product.id}); this.closest('.modal').remove();">Купить сейчас</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Add to Recently Viewed
        function addToRecentlyViewed(product) {
            recentlyViewed = recentlyViewed.filter(p => p.id !== product.id);
            recentlyViewed.unshift(product);
            if (recentlyViewed.length > 8) recentlyViewed.pop();
            localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
            displayRecentlyViewed();
        }
        
        // Display Recently Viewed
        function displayRecentlyViewed() {
            const container = document.getElementById('recentlyViewed');
            if (!container || recentlyViewed.length === 0) return;
            
            container.innerHTML = `
                <div class="recently-viewed">
                    <h3>Недавно просмотренные</h3>
                    <div class="recently-viewed-grid">
                        ${recentlyViewed.map(product => `
                            <div class="recent-item" onclick="showProductDetail(${product.id})">
                                <img src="${getProductImageUrl(product.category, product.name)}" alt="${product.name}" onerror="this.style.display='none'">
                                <div style="padding: 0.5rem; font-size: 12px;">${product.name.substring(0, 30)}...</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Price Filter
        function initPriceFilter() {
            if (products.length === 0) return;
            const minPrice = 0;
            const maxPrice = Math.max(...products.map(p => p.price), 100000);
            
            // Add price filter to products header if exists
            const productsHeader = document.querySelector('.products-header');
            if (productsHeader && !document.getElementById('priceFilterContainer')) {
                const priceFilter = document.createElement('div');
                priceFilter.id = 'priceFilterContainer';
                priceFilter.className = 'price-filter';
                priceFilter.innerHTML = `
                    <h4>Фильтр по цене</h4>
                    <input type="range" class="slider" id="priceMin" min="${minPrice}" max="${maxPrice}" value="${minPrice}" oninput="updatePriceInputs()">
                    <input type="range" class="slider" id="priceMax" min="${minPrice}" max="${maxPrice}" value="${maxPrice}" oninput="updatePriceInputs()">
                    <div class="price-range">
                        <input type="number" id="priceMinInput" value="${minPrice}" placeholder="Мин" oninput="updatePriceSliders()">
                        <span>-</span>
                        <input type="number" id="priceMaxInput" value="${maxPrice}" placeholder="Макс" oninput="updatePriceSliders()">
                        <button class="checkout-btn" onclick="applyPriceFilter()" style="width: auto; padding: 8px 16px;">Применить</button>
                    </div>
                `;
                productsHeader.appendChild(priceFilter);
            }
        }
        
        function updatePriceInputs() {
            const minSlider = document.getElementById('priceMin');
            const maxSlider = document.getElementById('priceMax');
            const minInput = document.getElementById('priceMinInput');
            const maxInput = document.getElementById('priceMaxInput');
            if (minSlider && minInput) minInput.value = minSlider.value;
            if (maxSlider && maxInput) maxInput.value = maxSlider.value;
        }
        
        function updatePriceSliders() {
            const minSlider = document.getElementById('priceMin');
            const maxSlider = document.getElementById('priceMax');
            const minInput = document.getElementById('priceMinInput');
            const maxInput = document.getElementById('priceMaxInput');
            if (minSlider && minInput) minSlider.value = minInput.value;
            if (maxSlider && maxInput) maxSlider.value = maxInput.value;
        }
        
        function applyPriceFilter() {
            const min = parseInt(document.getElementById('priceMinInput').value) || 0;
            const max = parseInt(document.getElementById('priceMaxInput').value) || 1000000;
            
            filteredProducts = products.filter(p => p.price >= min && p.price <= max);
            displayProducts(filteredProducts);
            
            // Update product counter
            const counter = document.querySelector('.product-counter');
            if (counter) counter.textContent = `Найдено: ${filteredProducts.length} товаров`;
        }
        
        // Smart Recommendations
        function displaySmartRecommendations() {
            const container = document.getElementById('smartRecommendations');
            if (!container || products.length === 0) return;
            
            // Get recommendations based on recently viewed
            const recommendations = products
                .filter(p => !recentlyViewed.some(r => r.id === p.id))
                .slice(0, 6);
            
            if (recommendations.length === 0) return;
            
            container.innerHTML = `
                <div class="smart-recommendations">
                    <h3>Рекомендуем для вас</h3>
                    <div class="products-grid">
                        ${recommendations.map(product => {
                            const imageUrl = getProductImageUrl(product.category, product.name);
                            return `
                            <div class="product-card">
                                <div class="product-image" style="background-image: url('${imageUrl}');" onclick="showProductDetail(${product.id})">
                                    <img src="${imageUrl}" alt="${product.name}" style="display: none;" onload="this.style.display='block'; this.parentElement.style.background='none';" onerror="this.parentElement.innerHTML='${product.image}';">
                                </div>
                                <div class="product-info">
                                    <h3 class="product-title">${product.name}</h3>
                                    <div class="product-price">${product.price.toLocaleString()} ₽</div>
                                    <button class="add-to-cart" onclick="addToCart(${product.id})">В корзину</button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }
        
        // Update breadcrumbs
        
        // Update product counter
        function updateProductCounter() {
            const counter = document.querySelector('.product-counter');
            if (!counter) return;
            const count = filteredProducts.length;
            counter.textContent = `Найдено: ${count} ${count === 1 ? 'товар' : count < 5 ? 'товара' : 'товаров'}`;
        }
        
        // Update DOMContentLoaded to include carousel initialization
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            
            let supabaseInitialized = false;
            let hasError = false;
            
            try {
                // Initialize Supabase
                supabaseInitialized = await initSupabase();
                
                // Load current user
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    AppState.currentUser = currentUser;
                    updateUserInterface();
                    
                    // Проверяем уведомления для продавца
                    checkSellerNotifications();
                }
                
                // Load products from database
                let dbProducts = [];
                try {
                    dbProducts = await fetchProductsFromDB();
                } catch (dbError) {
                    console.warn('Error fetching products from DB:', dbError);
                    // Не критично, продолжаем с localStorage
                }
                
                if (dbProducts.length > 0) {
                    products = dbProducts;
                } else {
                    // Если база пуста, используем начальные товары
                    products = initialProducts;
                    // Сохраняем в базу только если Supabase инициализирован
                    if (supabaseInitialized && initialProducts.length > 0) {
                        for (const product of initialProducts) {
                            try {
                                await saveProductToDB(product);
                            } catch (e) {
                                console.log('Product already exists or error:', e);
                            }
                        }
                    }
                }
                
                // Load users from database
                try {
                    const dbUsers = await fetchUsersFromDB();
                    if (dbUsers.length > 0) {
                        users = dbUsers;
                    }
                } catch (dbError) {
                    console.warn('Error fetching users from DB:', dbError);
                }
                
                // Load user products into main products (все товары видны всем)
                // userProducts уже должны быть в products из базы, но на всякий случай добавляем
                userProducts.forEach(product => {
                    if (!products.find(p => p.id === product.id)) {
                        products.push(product);
                    }
                });
                
                filteredProducts = [...products];
                // Всегда вызываем displayProducts для правильного управления видимостью секций
                displayProducts(products);
                updateProductCounter();
                updateCartDisplay();
                updateWishlistDisplay();
                
                // Initialize new features
                updateCompareBar();
                displayRecentlyViewed();
                setTimeout(() => {
                    initPriceFilter();
                    displaySmartRecommendations();
                    initRecommendedCarousel();
                }, 500);
                
                hideLoading();
                if (!hasError) {
                    showNotification('Добро пожаловать в Re - Minko!', 'success');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                hasError = true;
                hideLoading();
                
                // Показываем предупреждение только если это критическая ошибка
                if (error.message && !error.message.includes('TABLE_NOT_EXISTS') && !error.message.includes('PGRST116')) {
                    showNotification('Ошибка загрузки данных. Используется локальное хранилище.', 'warning');
                }
                
                // Fallback на localStorage
                try {
                    products = JSON.parse(localStorage.getItem('products')) || initialProducts;
                    filteredProducts = [...products];
                    // Всегда вызываем displayProducts для правильного управления видимостью секций
                    displayProducts(products);
                    updateProductCounter();
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    products = initialProducts;
                    filteredProducts = [...products];
                    displayProducts(products);
                    updateProductCounter();
                }
            }
        });
        
        // Show All Products
        function showAllProducts() {
            filteredProducts = [...products];
            displayProducts(filteredProducts);
            updateProductCounter();
            updateBreadcrumbs(null, null, '');
            // Прокручиваем к секции товаров только если она видна
            const productsSection = document.getElementById('productsSection');
            if (productsSection && productsSection.style.display !== 'none') {
                productsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Sort Products
        function sortProducts(sortType) {
            const sorted = [...filteredProducts];
            switch(sortType) {
                case 'price-low':
                    sorted.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    sorted.sort((a, b) => b.price - a.price);
                    break;
                case 'rating':
                    sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'newest':
                    sorted.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                    break;
            }
            filteredProducts = sorted;
            displayProducts(filteredProducts);
        }

        // Delivery Tracking Functions
        function showTracking(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('Заказ не найден', 'error');
                return;
            }

            const tracking = order.delivery || {
                status: 'pending',
                trackingNumber: order.trackingNumber || 'Не назначен',
                carrier: 'Re - Minko Delivery',
                estimatedDelivery: order.createdAt,
                trackingHistory: [{
                    status: 'pending',
                    message: 'Заказ создан',
                    timestamp: order.createdAt,
                    location: 'Склад Re - Minko'
                }]
            };

            const statusNames = {
                'pending': 'Ожидает обработки',
                'processing': 'Обрабатывается',
                'shipped': 'Отправлен',
                'in-transit': 'В пути',
                'out-for-delivery': 'Доставляется',
                'delivered': 'Доставлен'
            };

            const statusIcons = {
                'pending': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
                'processing': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>',
                'shipped': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 3h15v13H1zM16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
                'in-transit': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
                'out-for-delivery': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
                'delivered': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
            };

            const content = document.getElementById('trackingContent');
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <p style="color: #666; font-size: 14px; margin: 0.25rem 0;">Номер отслеживания</p>
                            <p style="font-weight: 600; font-size: 18px; margin: 0;">${tracking.trackingNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="color: #666; font-size: 14px; margin: 0.25rem 0;">Статус</p>
                            <p style="font-weight: 600; color: #ff9900; margin: 0;">${statusNames[tracking.status] || tracking.status}</p>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                        <p style="margin: 0.5rem 0; color: #666;">Перевозчик: ${tracking.carrier}</p>
                        <p style="margin: 0.5rem 0; color: #666;">Ожидаемая доставка: ${new Date(tracking.estimatedDelivery).toLocaleDateString('ru-RU')}</p>
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom: 1rem;">История доставки</h4>
                    <div class="tracking-timeline">
                        ${tracking.trackingHistory.map((entry, index) => `
                            <div class="tracking-item ${index === 0 ? 'active' : ''}">
                                <div class="tracking-icon">${statusIcons[entry.status] || statusIcons.pending}</div>
                                <div class="tracking-content">
                                    <p style="font-weight: 500; margin: 0 0 0.25rem 0;">${entry.message}</p>
                                    <p style="color: #666; font-size: 12px; margin: 0 0 0.25rem 0;">${entry.location || ''}</p>
                                    <p style="color: #999; font-size: 11px; margin: 0;">${new Date(entry.timestamp).toLocaleString('ru-RU')}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('trackingModal').style.display = 'block';
        }

        function closeTrackingModal() {
            document.getElementById('trackingModal').style.display = 'none';
        }

        // Support Chat Functions
        let supportMessages = JSON.parse(localStorage.getItem('supportMessages')) || [];

        function showSupportChat() {
            document.getElementById('supportChatModal').style.display = 'block';
            loadSupportMessages();
        }

        function closeSupportChat() {
            document.getElementById('supportChatModal').style.display = 'none';
        }

        function loadSupportMessages() {
            const container = document.getElementById('supportMessages');
            if (!container) return;

            const messagesHtml = supportMessages.map(msg => `
                <div class="support-message ${msg.from === 'user' ? 'support-message-user' : 'support-message-system'}">
                    <div class="support-avatar">${msg.from === 'user' ? '👤' : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>'}</div>
                    <div class="support-content">
                        <p>${sanitizeInput(msg.text)}</p>
                        <small style="color: #999; font-size: 11px;">${new Date(msg.timestamp).toLocaleTimeString('ru-RU')}</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="support-message support-message-system">
                    <div class="support-avatar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="support-content">
                        <p>Здравствуйте! Я виртуальный помощник Re - Minko. Чем могу помочь?</p>
                    </div>
                </div>
                ${messagesHtml}
            `;
            container.scrollTop = container.scrollHeight;
        }

        function sendSupportMessage() {
            const input = document.getElementById('supportInput');
            if (!input || !input.value.trim()) return;

            const text = sanitizeInput(input.value);
            const message = {
                id: Date.now(),
                from: 'user',
                text: text,
                timestamp: new Date().toISOString()
            };

            supportMessages.push(message);
            localStorage.setItem('supportMessages', JSON.stringify(supportMessages));
            input.value = '';

            loadSupportMessages();

            // Auto response simulation
            setTimeout(() => {
                const responses = [
                    'Спасибо за вопрос. Наш специалист свяжется с вами в ближайшее время.',
                    'Понял ваш вопрос. Проверяю информацию...',
                    'Это важный вопрос. Обрабатываю запрос...',
                    'Спасибо за обращение. Мы обязательно поможем вам решить эту проблему.'
                ];
                const response = {
                    id: Date.now() + 1,
                    from: 'support',
                    text: responses[Math.floor(Math.random() * responses.length)],
                    timestamp: new Date().toISOString()
                };
                supportMessages.push(response);
                localStorage.setItem('supportMessages', JSON.stringify(supportMessages));
                loadSupportMessages();
            }, 1500);
        }

        function handleSupportKeyPress(event) {
            if (event.key === 'Enter') {
                sendSupportMessage();
            }
        }

        // Supabase Integration
        const SUPABASE_URL = 'https://irphwifczmmjjbpyhedm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycGh3aWZjem1tampicHloZWRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODQ1MTcsImV4cCI6MjA3Nzg2MDUxN30._K5jA9PB-iPIWMfwiercdFGw10iiEUkxqlMT1Wp9BYc';
        
        let supabase = null;
        
        async function initSupabase() {
            try {
                // Ждем загрузки Supabase CDN
                let attempts = 0;
                while (attempts < 10 && (!window.supabase || typeof window.supabase.createClient !== 'function')) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    const { createClient } = window.supabase;
                    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('✅ Supabase initialized');
                    
                    // Проверяем подключение (необязательно)
                    try {
                        const { error } = await supabase.from('products').select('count').limit(1);
                        if (error && error.code !== 'PGRST116' && error.code !== '42P01') {
                            console.warn('⚠️ Supabase connection issue:', error.message);
                        }
                    } catch (e) {
                        // Игнорируем ошибки при проверке
                    }
                    
                    return true;
                } else {
                    // Fallback: используем localStorage
                    console.log('⚠️ Supabase CDN не загружен, используем localStorage');
                    return false;
                }
            } catch (error) {
                console.error('❌ Supabase initialization error:', error);
                return false;
            }
        }

        // Database Functions
        async function fetchProductsFromDB() {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('products')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        // Если таблица не существует, возвращаем пустой массив
                        if (error.code === 'PGRST116' || error.code === '42P01') {
                            console.log('📋 Таблица products не существует. Создайте таблицы согласно SUPABASE_SETUP.md');
                            return [];
                        }
                        throw error;
                    }
                    
                    // Преобразуем данные из Supabase в формат приложения
                    return (data || []).map(item => {
                        // Парсим images если это JSON строка
                        let images = [];
                        if (item.images) {
                            try {
                                images = typeof item.images === 'string' ? JSON.parse(item.images) : item.images;
                            } catch (e) {
                                images = Array.isArray(item.images) ? item.images : [];
                            }
                        }
                        
                        return {
                            id: item.id,
                            name: item.name,
                            description: item.description,
                            price: parseFloat(item.price),
                            originalPrice: item.original_price ? parseFloat(item.original_price) : null,
                            category: item.category,
                            subcategory: item.subcategory,
                            image: item.image || (images.length > 0 ? images[0] : '📦'),
                            images: images.length > 0 ? images : (item.image && item.image.startsWith('data:image') ? [item.image] : []),
                            stock: item.stock,
                            rating: item.rating || 0,
                            badge: item.badge,
                            sellerId: item.seller_id,
                            sellerName: item.seller_name,
                            createdAt: item.created_at || item.createdAt
                        };
                    });
                } else {
                    // Fallback: используем localStorage
                    return JSON.parse(localStorage.getItem('products')) || [];
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                return JSON.parse(localStorage.getItem('products')) || [];
            }
        }

        async function saveProductToDB(product) {
            try {
                if (supabase) {
                    // Преобразуем данные для Supabase
                    const productData = {
                        name: product.name,
                        description: product.description || '',
                        price: product.price,
                        original_price: product.originalPrice || null,
                        category: product.category,
                        subcategory: product.subcategory || null,
                        image: product.image || (product.images && product.images.length > 0 ? product.images[0] : '📦'),
                        images: product.images && product.images.length > 0 ? JSON.stringify(product.images) : null,
                        stock: product.stock || 0,
                        rating: product.rating || 0,
                        badge: product.badge || null,
                        seller_id: product.sellerId || null,
                        seller_name: product.sellerName || null
                    };
                    
                    const { data, error } = await supabase
                        .from('products')
                        .insert([productData])
                        .select();
                    
                    if (error) {
                        // Если таблица не существует, используем fallback
                        if (error.code === 'PGRST116' || error.code === '42P01') {
                            console.log('📋 Таблица products не существует. Используем localStorage');
                            throw new Error('TABLE_NOT_EXISTS');
                        }
                        throw error;
                    }
                    
                    // Преобразуем обратно в формат приложения
                    const saved = data[0];
                    return {
                        ...product,
                        id: saved.id,
                        createdAt: saved.created_at
                    };
                } else {
                    // Fallback: localStorage
                    const products = JSON.parse(localStorage.getItem('products')) || [];
                    products.push(product);
                    localStorage.setItem('products', JSON.stringify(products));
                    return product;
                }
            } catch (error) {
                if (error.message === 'TABLE_NOT_EXISTS') {
                    // Используем localStorage как fallback
                    const products = JSON.parse(localStorage.getItem('products')) || [];
                    products.push(product);
                    localStorage.setItem('products', JSON.stringify(products));
                    return product;
                }
                console.error('Error saving product:', error);
                throw error;
            }
        }

        async function fetchOrdersFromDB(userId) {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('orders')
                        .select('*')
                        .eq('buyer_id', userId)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    return data || [];
                } else {
                    return orders.filter(o => o.buyerId === userId);
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
                return [];
            }
        }

        async function saveOrderToDB(order) {
            try {
                if (supabase) {
                    const orderData = {
                        buyer_id: order.buyerId,
                        buyer_name: order.buyerName,
                        items: order.items,
                        subtotal: order.subtotal,
                        commission: order.commission,
                        total: order.total,
                        status: order.status,
                        tracking_number: order.trackingNumber,
                        delivery: order.delivery,
                        payment_method: order.paymentMethod
                    };
                    
                    const { data, error } = await supabase
                        .from('orders')
                        .insert([orderData])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    orders.push(order);
                    localStorage.setItem('orders', JSON.stringify(orders));
                    return order;
                }
            } catch (error) {
                console.error('Error saving order:', error);
                throw error;
            }
        }

        async function fetchUsersFromDB() {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('users')
                        .select('*');
                    
                    if (error) throw error;
                    return data || [];
                } else {
                    return JSON.parse(localStorage.getItem('users')) || [];
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                return JSON.parse(localStorage.getItem('users')) || [];
            }
        }

        async function saveUserToDB(user) {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('users')
                        .insert([{
                            name: user.name,
                            email: user.email,
                            password_hash: user.password, // В продакшене нужно хешировать!
                            created_at: new Date().toISOString()
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    users.push(user);
                    localStorage.setItem('users', JSON.stringify(users));
                    return user;
                }
            } catch (error) {
                console.error('Error saving user:', error);
                throw error;
            }
        }

        // Security Functions
        function hashPassword(password) {
            // В реальном приложении используйте bcrypt или подобное
            // Это только пример структуры
            return btoa(password); // НЕ используйте в продакшене!
        }

        function rateLimitCheck(action, maxAttempts = 5, windowMs = 60000) {
            const key = `rateLimit_${action}`;
            const attempts = JSON.parse(localStorage.getItem(key) || '[]');
            const now = Date.now();
            const recentAttempts = attempts.filter(t => now - t < windowMs);
            
            if (recentAttempts.length >= maxAttempts) {
                return false;
            }
            
            recentAttempts.push(now);
            localStorage.setItem(key, JSON.stringify(recentAttempts));
            return true;
        }

        function validateCSRFToken(token) {
            // Простая CSRF защита
            const storedToken = sessionStorage.getItem('csrfToken');
            return storedToken === token;
        }

        function generateCSRFToken() {
            const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            sessionStorage.setItem('csrfToken', token);
            return token;
        }

        // Инициализация безопасности при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            generateCSRFToken();
        });

        // CSS для отслеживания и поддержки
        const trackingStyles = `
            <style>
            .tracking-timeline {
                position: relative;
                padding-left: 2rem;
            }
            
            .tracking-item {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                position: relative;
            }
            
            .tracking-item:not(:last-child)::before {
                content: '';
                position: absolute;
                left: 11px;
                top: 32px;
                width: 2px;
                height: calc(100% + 0.5rem);
                background: #e0e0e0;
            }
            
            .tracking-icon {
                width: 24px;
                height: 24px;
                flex-shrink: 0;
                background: #f0f0f0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #999;
            }
            
            .tracking-item.active .tracking-icon {
                background: #ff9900;
                color: white;
            }
            
            .tracking-content {
                flex: 1;
            }
            
            .support-message {
                display: flex;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .support-message-user {
                flex-direction: row-reverse;
            }
            
            .support-avatar {
                width: 32px;
                height: 32px;
                flex-shrink: 0;
                background: #f0f0f0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .support-content {
                background: white;
                padding: 0.75rem 1rem;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
                max-width: 70%;
            }
            
            .support-message-user .support-content {
                background: #ff9900;
                color: white;
            }
            </style>
        `;
        document.head.insertAdjacentHTML('beforeend', trackingStyles);

        // ============================================
        // 25 НОВЫХ ФУНКЦИЙ ДЛЯ ОНЛАЙН-МАГАЗИНА
        // ============================================

        // 1. Сортировка товаров по цене, рейтингу, популярности
        function sortProducts(sortBy = 'default') {
            showLoading();
            setTimeout(() => {
                const sorted = [...filteredProducts];
                switch(sortBy) {
                    case 'price-low':
                        sorted.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-high':
                        sorted.sort((a, b) => b.price - a.price);
                        break;
                    case 'rating':
                        sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                        break;
                    case 'popularity':
                        sorted.sort((a, b) => (b.stock || 0) - (a.stock || 0));
                        break;
                    case 'newest':
                        sorted.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                        break;
                    default:
                        break;
                }
                filteredProducts = sorted;
                displayProducts(filteredProducts);
                hideLoading();
                showNotification(`Товары отсортированы: ${getSortLabel(sortBy)}`, 'success');
            }, 200);
        }

        function getSortLabel(sortBy) {
            const labels = {
                'price-low': 'По возрастанию цены',
                'price-high': 'По убыванию цены',
                'rating': 'По рейтингу',
                'popularity': 'По популярности',
                'newest': 'Сначала новые'
            };
            return labels[sortBy] || 'По умолчанию';
        }

        // 2. Фильтр по цене (диапазон)
        function filterByPriceRange(min, max) {
            showLoading();
            setTimeout(() => {
                filteredProducts = products.filter(p => p.price >= min && p.price <= max);
                displayProducts(filteredProducts);
                updateProductCounter();
                hideLoading();
                if (filteredProducts.length === 0) {
                    showNotification('Товары в этом диапазоне цен не найдены', 'info');
                }
            }, 200);
        }

        // 3. Поиск по описанию товара
        function searchInDescriptions(query) {
            if (!query || query.length < 2) return;
            showLoading();
            setTimeout(() => {
                const lowerQuery = query.toLowerCase();
                filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(lowerQuery) ||
                    (p.description && p.description.toLowerCase().includes(lowerQuery))
                );
                displayProducts(filteredProducts);
                updateProductCounter();
                hideLoading();
            }, 200);
        }

        // 4. Экспорт списка товаров в CSV
        function exportProductsToCSV() {
            const csv = [
                ['Название', 'Цена', 'Категория', 'Рейтинг', 'Остаток'].join(','),
                ...filteredProducts.map(p => [
                    `"${p.name}"`,
                    p.price,
                    p.category,
                    p.rating || 0,
                    p.stock || 0
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `products_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('Список товаров экспортирован', 'success');
        }

        // 5. Поделиться товаром
        function shareProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const shareData = {
                title: product.name,
                text: `${product.name} - ${product.price.toLocaleString()} ₽`,
                url: window.location.href + `#product-${productId}`
            };
            
            if (navigator.share) {
                navigator.share(shareData).catch(() => {
                    copyToClipboard(shareData.url);
                });
            } else {
                copyToClipboard(shareData.url);
            }
        }

        // 6. Копировать в буфер обмена
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Ссылка скопирована в буфер обмена', 'success');
            }).catch(() => {
                showNotification('Не удалось скопировать', 'error');
            });
        }

        // 7. Добавить товар в список желаний с уведомлением
        function addToWishlistWithNotify(productId) {
            addToWishlist(productId);
            const product = products.find(p => p.id === productId);
            if (product) {
                showNotification(`"${product.name}" добавлен в избранное`, 'success');
            }
        }

        // 8. Быстрая покупка (добавить в корзину и сразу оформить)
        async function quickBuy(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (!currentUser) {
                showNotification('Необходимо войти для покупки', 'warning');
                showLoginModal();
                return;
            }
            
            // Очищаем корзину и добавляем один товар
            cart = [{...product, quantity: 1}];
            updateCartDisplay();
            toggleCart();
            showNotification('Товар добавлен в корзину. Оформите заказ', 'info');
        }

        // 9. Показать похожие товары
        function showSimilarProducts(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const similar = products
                .filter(p => 
                    p.id !== productId && 
                    (p.category === product.category || p.subcategory === product.subcategory)
                )
                .slice(0, 4);
            
            if (similar.length === 0) {
                showNotification('Похожие товары не найдены', 'info');
                return;
            }
            
            // Создаем модальное окно с похожими товарами
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Похожие товары</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="products-grid" style="padding: 1rem;">
                        ${similar.map(p => `
                            <div class="product-card">
                                <div class="product-image" onclick="showProductDetail(${p.id}); this.closest('.modal').remove();">
                                    ${p.image}
                                </div>
                                <div class="product-info">
                                    <h3>${p.name}</h3>
                                    <div class="product-price">${p.price.toLocaleString()} ₽</div>
                                    <button class="add-to-cart" onclick="addToCart(${p.id})">В корзину</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 10. История просмотров товаров (расширенная)
        function addToViewHistory(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            let history = JSON.parse(localStorage.getItem('viewHistory') || '[]');
            history = history.filter(p => p.id !== productId);
            history.unshift({...product, viewedAt: new Date().toISOString()});
            if (history.length > 20) history.pop();
            localStorage.setItem('viewHistory', JSON.stringify(history));
        }

        // 11. Показать историю просмотров
        function showViewHistory() {
            const history = JSON.parse(localStorage.getItem('viewHistory') || '[]');
            if (history.length === 0) {
                showNotification('История просмотров пуста', 'info');
                return;
            }
            
            filteredProducts = history.map(h => products.find(p => p.id === h.id)).filter(Boolean);
            displayProducts(filteredProducts);
            updateProductCounter();
            showNotification(`Показано ${history.length} товаров из истории`, 'success');
        }

        // 12. Уведомление о снижении цены (отслеживание)
        function trackPriceDrop(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            let tracked = JSON.parse(localStorage.getItem('priceTracking') || '[]');
            if (tracked.find(t => t.id === productId)) {
                showNotification('Цена этого товара уже отслеживается', 'info');
                return;
            }
            
            tracked.push({
                id: productId,
                currentPrice: product.price,
                originalPrice: product.originalPrice || product.price,
                addedAt: new Date().toISOString()
            });
            localStorage.setItem('priceTracking', JSON.stringify(tracked));
            showNotification('Отслеживание цены активировано. Вы получите уведомление при снижении', 'success');
        }

        // 13. Показать товары со скидками
        function showDiscountedProducts() {
            filteredProducts = products.filter(p => p.originalPrice && p.originalPrice > p.price);
            displayProducts(filteredProducts);
            updateProductCounter();
            updateBreadcrumbs(null, null, 'Товары со скидками');
            showNotification(`Найдено ${filteredProducts.length} товаров со скидками`, 'success');
        }

        // 14. Фильтр по наличию на складе
        function filterByStock(inStock = true) {
            if (inStock) {
                filteredProducts = products.filter(p => (p.stock || 0) > 0);
            } else {
                filteredProducts = products.filter(p => (p.stock || 0) === 0);
            }
            displayProducts(filteredProducts);
            updateProductCounter();
        }

        // 15. Сравнение цен с другими магазинами (симуляция)
        function comparePrices(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Симулируем цены в других магазинах
            const competitors = [
                { name: 'Конкурент 1', price: product.price * 1.1 },
                { name: 'Конкурент 2', price: product.price * 0.95 },
                { name: 'Конкурент 3', price: product.price * 1.05 }
            ];
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Сравнение цен: ${product.name}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>Re - Minko:</strong> ${product.price.toLocaleString()} ₽ ✅ Лучшая цена
                        </div>
                        ${competitors.map(c => `
                            <div style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">
                                <strong>${c.name}:</strong> ${c.price.toLocaleString()} ₽
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 16. Генератор промокодов
        function generatePromoCode(discount = 10) {
            const code = 'PROMO' + Math.random().toString(36).substr(2, 8).toUpperCase();
            let promos = JSON.parse(localStorage.getItem('promoCodes') || '[]');
            promos.push({
                code,
                discount,
                createdAt: new Date().toISOString(),
                used: false
            });
            localStorage.setItem('promoCodes', JSON.stringify(promos));
            showNotification(`Промокод создан: ${code} (скидка ${discount}%)`, 'success');
            return code;
        }

        // 17. Применить промокод
        function applyPromoCode(code) {
            const promos = JSON.parse(localStorage.getItem('promoCodes') || '[]');
            const promo = promos.find(p => p.code === code && !p.used);
            
            if (!promo) {
                showNotification('Промокод недействителен или уже использован', 'error');
                return false;
            }
            
            // Применяем скидку к корзине
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const discount = total * (promo.discount / 100);
            
            promo.used = true;
            localStorage.setItem('promoCodes', JSON.stringify(promos));
            localStorage.setItem('activePromo', JSON.stringify({ code, discount }));
            
            showNotification(`Промокод применен! Скидка: ${discount.toLocaleString()} ₽`, 'success');
            updateCartDisplay();
            return true;
        }

        // 18. Рейтинг продавца
        function getSellerRating(sellerId) {
            const sellerProducts = products.filter(p => p.sellerId === sellerId);
            if (sellerProducts.length === 0) return 0;
            
            const avgRating = sellerProducts.reduce((sum, p) => sum + (p.rating || 0), 0) / sellerProducts.length;
            return Math.round(avgRating * 10) / 10;
        }

        // 19. Показать товары конкретного продавца
        function showSellerProducts(sellerId) {
            filteredProducts = products.filter(p => p.sellerId === sellerId);
            displayProducts(filteredProducts);
            updateProductCounter();
            const seller = products.find(p => p.sellerId === sellerId);
            if (seller) {
                updateBreadcrumbs(null, null, `Товары продавца: ${seller.sellerName}`);
            }
        }

        // 20. Уведомление о поступлении товара
        function notifyWhenAvailable(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (product.stock > 0) {
                showNotification('Товар уже в наличии', 'info');
                return;
            }
            
            let notifications = JSON.parse(localStorage.getItem('availabilityNotifications') || '[]');
            if (notifications.find(n => n.productId === productId)) {
                showNotification('Вы уже подписаны на уведомления об этом товаре', 'info');
                return;
            }
            
            notifications.push({
                productId,
                productName: product.name,
                email: currentUser?.email || '',
                createdAt: new Date().toISOString()
            });
            localStorage.setItem('availabilityNotifications', JSON.stringify(notifications));
            showNotification('Вы будете уведомлены, когда товар появится в наличии', 'success');
        }

        // 21. Экспорт корзины в список покупок
        function exportCartToShoppingList() {
            if (cart.length === 0) {
                showNotification('Корзина пуста', 'warning');
                return;
            }
            
            const list = cart.map(item => `${item.name} - ${item.quantity} шт.`).join('\n');
            const blob = new Blob([list], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `shopping_list_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            showNotification('Список покупок экспортирован', 'success');
        }

        // 22. Быстрый поиск по артикулу/ID
        function searchByID(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                showProductDetail(productId);
            } else {
                showNotification('Товар с таким ID не найден', 'error');
            }
        }

        // 23. Показать статистику магазина
        function showStoreStats() {
            const stats = {
                totalProducts: products.length,
                totalCategories: new Set(products.map(p => p.category)).size,
                avgPrice: Math.round(products.reduce((sum, p) => sum + p.price, 0) / products.length),
                totalStock: products.reduce((sum, p) => sum + (p.stock || 0), 0),
                avgRating: (products.reduce((sum, p) => sum + (p.rating || 0), 0) / products.length).toFixed(1)
            };
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>📊 Статистика магазина</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <strong>Всего товаров:</strong> ${stats.totalProducts}
                        </div>
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <strong>Категорий:</strong> ${stats.totalCategories}
                        </div>
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <strong>Средняя цена:</strong> ${stats.avgPrice.toLocaleString()} ₽
                        </div>
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <strong>Остаток на складе:</strong> ${stats.totalStock} шт.
                        </div>
                        <div style="padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <strong>Средний рейтинг:</strong> ${stats.avgRating} ⭐
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 24. Автозаполнение адреса доставки
        function autoFillDeliveryAddress() {
            if (!currentUser) return;
            
            const savedAddress = localStorage.getItem(`deliveryAddress_${currentUser.id}`);
            if (savedAddress) {
                const address = JSON.parse(savedAddress);
                // Заполняем форму доставки если она есть
                const addressInput = document.getElementById('deliveryAddress');
                if (addressInput) {
                    addressInput.value = address.full;
                }
                showNotification('Адрес доставки заполнен автоматически', 'success');
            }
        }

        // 25. Умные рекомендации на основе корзины
        function getSmartRecommendations() {
            if (cart.length === 0) return [];
            
            const cartCategories = [...new Set(cart.map(item => item.category))];
            const recommendations = products
                .filter(p => 
                    !cart.find(c => c.id === p.id) &&
                    (cartCategories.includes(p.category) || cartCategories.includes(p.subcategory))
                )
                .slice(0, 5);
            
            return recommendations;
        }

        // Перехватываем вызовы addToCart для умных рекомендаций
        const originalAddToCartFunc = window.addToCart;
        if (originalAddToCartFunc) {
            window.addToCart = function(productId) {
                originalAddToCartFunc(productId);
                setTimeout(() => {
                    const recommendations = getSmartRecommendations();
                    if (recommendations.length > 0 && Math.random() > 0.7) {
                        showNotification(`💡 Рекомендуем: ${recommendations[0].name}`, 'info');
                    }
                }, 1000);
            };
        }

        // Инициализация дополнительных функций при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Добавляем кнопку сортировки если её нет
            const productsSection = document.getElementById('productsSection');
            if (productsSection && !document.getElementById('sortProducts')) {
                const sortDiv = document.createElement('div');
                sortDiv.id = 'sortProducts';
                sortDiv.style.cssText = 'margin: 1rem 0; display: flex; gap: 0.5rem; flex-wrap: wrap;';
                sortDiv.innerHTML = `
                    <select onchange="sortProducts(this.value)" style="padding: 0.5rem; border: 1px solid #d0d0d0; border-radius: 4px;">
                        <option value="default">Сортировка</option>
                        <option value="price-low">По возрастанию цены</option>
                        <option value="price-high">По убыванию цены</option>
                        <option value="rating">По рейтингу</option>
                        <option value="popularity">По популярности</option>
                        <option value="newest">Сначала новые</option>
                    </select>
                    <button onclick="showDiscountedProducts()" class="btn-secondary">Товары со скидками</button>
                    <button onclick="showStoreStats()" class="btn-secondary">📊 Статистика</button>
                `;
                const productsGrid = document.getElementById('productsGrid');
                if (productsGrid && productsGrid.parentElement) {
                    productsGrid.parentElement.insertBefore(sortDiv, productsGrid);
                }
            }
        });

    </script>
</body>
</html>
